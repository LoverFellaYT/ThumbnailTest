<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Editing Rubric | [Your Team Name]</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/dialog-polyfill/dist/dialog-polyfill.js"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/dialog-polyfill/dist/dialog-polyfill.css" />

    <style>
        /* CSS Variables & Base Styles */
        :root {
            --primary-light: #4facfe; /* Light Blue */
            --accent-light: #00f2fe;  /* Cyan */
            --primary-rgb: 79, 172, 254; /* RGB for rgba() usage */
            --accent-rgb: 0, 242, 254;   /* RGB for rgba() usage */

            --bg-light: #f9fafb; /* Very light grey */
            --text-light: #1f2937; /* Dark grey-blue */
            --panel-light: rgba(255, 255, 255, 0.9); /* Slightly less opaque panel */
            --border-light: rgba(0, 0, 0, 0.08); /* Softer border */
            --header-bg-light: rgba(255, 255, 255, 0.88);
            --table-header-bg-light: rgba(249, 250, 251, 0.9); /* Lighter table header */
            --table-cell-bg-light: rgba(255, 255, 255, 0.9);
            --table-cell-hover-light: rgba(var(--primary-rgb), 0.05); /* Subtle blue hover */
            --selected-highlight-light: rgba(var(--primary-rgb), 0.15); /* Clearer selected bg */
            --selected-border-light: var(--primary-light);
            --input-bg-light: #ffffff;
            --input-border-light: #d1d5db; /* Grey border */
            --input-focus-border-light: var(--primary-light);
            --input-focus-shadow-light: 0 0 0 3px rgba(var(--primary-rgb), 0.2);
            --placeholder-text-light: #9ca3af;

            /* Dark Mode Overrides */
            --bg-dark: #111827; /* Dark blue-grey */
            --text-dark: #e5e7eb; /* Light grey */
            --panel-dark: rgba(31, 41, 55, 0.92); /* Dark panel bg */
            --border-dark: rgba(255, 255, 255, 0.12); /* Softer dark border */
            --header-bg-dark: rgba(17, 24, 39, 0.9); /* Darker header */
            --table-header-bg-dark: rgba(31, 41, 55, 0.9); /* Match panel */
            --table-cell-bg-dark: rgba(55, 65, 81, 0.88); /* Slightly lighter cells */
            --table-cell-hover-dark: rgba(var(--accent-rgb), 0.1); /* Subtle cyan hover */
            --selected-highlight-dark: rgba(var(--accent-rgb), 0.2); /* Clearer selected bg */
            --selected-border-dark: var(--accent-light);
            --input-bg-dark: #1f2937; /* Match text color base */
            --input-border-dark: #4b5563; /* Mid-grey border */
            --input-focus-border-dark: var(--accent-light);
            --input-focus-shadow-dark: 0 0 0 3px rgba(var(--accent-rgb), 0.25);
            --placeholder-text-dark: #6b7280;

            /* Shared variables */
            --shadow: 0 6px 24px rgba(31, 38, 135, 0.06); /* Softer shadow */
            --transition: all 0.25s ease-in-out; /* Slightly smoother transition */
            --radius: 10px; /* Slightly smaller radius */
            --gradient: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%);
            --spacing: 1rem; /* Base spacing unit */
            --font-base: 'Roboto', sans-serif;
        }

        /* Apply theme variables */
        html {
            --bg: var(--bg-light);
            --text: var(--text-light);
            --panel: var(--panel-light);
            --border: var(--border-light);
            --header-bg: var(--header-bg-light);
            --table-header-bg: var(--table-header-bg-light);
            --table-cell-bg: var(--table-cell-bg-light);
            --table-cell-hover: var(--table-cell-hover-light);
            --selected-highlight: var(--selected-highlight-light);
            --selected-border: var(--selected-border-light);
            --input-bg: var(--input-bg-light);
            --input-border: var(--input-border-light);
            --input-focus-border: var(--input-focus-border-light);
            --input-focus-shadow: var(--input-focus-shadow-light);
            --placeholder-text: var(--placeholder-text-light);
        }

        html[data-theme="dark"] {
            --bg: var(--bg-dark);
            --text: var(--text-dark);
            --panel: var(--panel-dark);
            --border: var(--border-dark);
            --header-bg: var(--header-bg-dark);
            --table-header-bg: var(--table-header-bg-dark);
            --table-cell-bg: var(--table-cell-bg-dark);
            --table-cell-hover: var(--table-cell-hover-dark);
            --selected-highlight: var(--selected-highlight-dark);
            --selected-border: var(--selected-border-dark);
            --input-bg: var(--input-bg-dark);
            --input-border: var(--input-border-dark);
            --input-focus-border: var(--input-focus-border-dark);
            --input-focus-shadow: var(--input-focus-shadow-dark);
            --placeholder-text: var(--placeholder-text-dark);
        }

        /* Base styles */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-base);
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s ease, color 0.3s ease;
            line-height: 1.6; /* Improved default line height */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Improved Focus States */
        *:focus-visible {
             outline: 2px solid transparent; /* Remove default outline */
             outline-offset: 2px;
             box-shadow: 0 0 0 3px var(--bg), 0 0 0 5px var(--accent-light); /* More visible focus ring */
             border-radius: 3px; /* Optional: round the focus indicator slightly */
        }
        /* Specific focus for inputs/textarea for consistency */
        input:focus-visible, textarea:focus-visible {
             outline: none; /* Remove default */
             border-color: var(--input-focus-border);
             box-shadow: var(--input-focus-shadow); /* Use variable defined focus shadow */
        }


        /* Panels */
        .glass-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px); /* Slightly more blur */
            padding: calc(var(--spacing) * 1.8); /* Increased padding */
            margin-bottom: calc(var(--spacing) * 1.5); /* Increased bottom margin */
            transition: var(--transition);
        }

        /* HEADER */
        .analyzer-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: var(--spacing) calc(var(--spacing) * 1.8); /* Match panel padding */
            margin-bottom: calc(var(--spacing) * 1.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: calc(var(--spacing) * 1.5); /* Increased gap */
            background: var(--header-bg);
            border-bottom: 1px solid var(--border); /* Add subtle bottom border */
        }

        .header-left { display: flex; flex-direction: column; gap: 0.35rem; } /* Slightly more gap */
        .site-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.6rem; }
        .site-title i { color: var(--primary-light); }

        .total-score {
            font-size: 1.1rem;
            font-weight: 600;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            cursor: default;
        }
        .total-score::after { /* Tooltip styling */
             content: attr(data-tooltip);
             position: absolute;
             background: var(--text); /* Match theme text color base */
             color: var(--bg); /* Match theme bg color base */
             padding: 0.5rem 0.9rem;
             border-radius: 6px;
             top: 130%; /* Position further below */
             left: 50%;
             transform: translateX(-50%);
             white-space: nowrap;
             font-size: 0.8rem;
             font-weight: 500;
             z-index: 10;
             opacity: 0;
             visibility: hidden;
             transition: opacity 0.2s ease, visibility 0.2s ease, top 0.2s ease; /* Smooth appearance */
             box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .total-score:hover::after,
        .total-score:focus-visible::after { /* Show tooltip on hover/focus */
             opacity: 1;
             visibility: visible;
             top: 120%; /* Move slightly up */
        }

        .status-indicator { font-weight: 500; font-size: 0.95rem; opacity: 0.9; }
        .header-right { display: flex; align-items: center; gap: var(--spacing); flex-wrap: wrap; }

        /* Buttons */
        .btn {
            background: var(--gradient);
            color: #ffffff;
            border: none;
            padding: 0.7rem 1.4rem; /* Slightly larger padding */
            border-radius: 8px; /* Match input radius */
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            text-decoration: none;
            line-height: 1;
        }
        .btn:hover, .btn:focus-visible {
            transform: translateY(-2px) scale(1.02); /* Add subtle scale */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }
        .btn:active {
            transform: translateY(0px) scale(1); /* Reset transform on click */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .btn i { line-height: 1; }

        /* Dark Mode Slider */
        .dark-mode-label { cursor: pointer; display: inline-flex; align-items: center; gap: 0.6rem; }
        .dark-mode-slider { /* Styles mostly unchanged, visually fine */
             position: relative; width: 50px; height: 26px; background-color: #ccc; border-radius: 13px;
             display: flex; align-items: center; justify-content: space-between; padding: 0 4px; transition: background-color 0.3s ease;
        }
        html[data-theme="dark"] .dark-mode-slider { background-color: #555; }
        .dark-mode-slider .mode-icon { font-size: 14px; color: #fff; }
        .dark-mode-slider .slider-thumb {
            position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%;
            top: 2px; left: 2px; transition: transform 0.3s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input#darkModeToggle { opacity: 0; width: 0; height: 0; position: absolute; } /* Better hiding */
        input#darkModeToggle:checked + .dark-mode-slider .slider-thumb { transform: translateX(24px); }
        input#darkModeToggle:checked + .dark-mode-slider { background-color: var(--primary-light); }

        /* Main Content */
        main { margin: var(--spacing) auto; max-width: 1600px; padding: 0 var(--spacing); }
        .analyzer-container { padding: 0; } /* Remove padding here, handled by panels */

         /* Section Styling */
        .content-section { /* Apply to video info, rubric, feedback, legend sections */
            margin-bottom: calc(var(--spacing) * 1.5);
            background: var(--panel); /* Use panel bg directly on sections */
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: calc(var(--spacing) * 1.8); /* Consistent padding */
        }
         /* Adjust headings within sections */
         .content-section h2 {
             margin-top: 0;
             margin-bottom: calc(var(--spacing) * 1.2); /* More space below heading */
             font-size: 1.25rem; /* Standardized section heading size */
             font-weight: 600;
             padding-bottom: 0.5rem;
             border-bottom: 1px solid var(--border); /* Subtle separator */
         }

         /* Video Info Section */
        .info-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
             gap: calc(var(--spacing) * 1.2); /* Increased gap */
        }
        .info-grid label { font-weight: 500; display: block; margin-bottom: 0.4rem; font-size: 0.9rem; }
        .info-grid input[type="text"],
        .info-grid input[type="url"] {
            width: 100%;
            padding: 0.7rem 1rem; /* Increased padding */
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text);
            transition: var(--transition);
            box-sizing: border-box;
        }
        /* input focus handled by global *:focus-visible */

        /* Rubric Table */
        .rubric-table-wrapper { overflow-x: auto; margin-top: var(--spacing); }
        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-family: var(--font-base);
            /* removed shadow/radius here, handled by wrapper section */
            transition: var(--transition);
        }
        .modern-table thead th {
            padding: 0.9rem 1.3rem; /* Increased padding */
            font-weight: 600;
            position: sticky;
            top: 0;
            background: var(--table-header-bg);
            backdrop-filter: blur(6px);
            z-index: 10;
            text-align: left;
            border-bottom: 2px solid var(--border);
            color: var(--text);
            white-space: nowrap;
            transition: var(--transition);
        }
        .modern-table thead th:first-child { /* Category Header */
            background: var(--gradient);
            color: #ffffff;
            position: sticky;
            left: 0;
            z-index: 11;
            border-right: 1px solid var(--border); /* Add separator */
        }
        /* Rating Column Headers */
        .modern-table thead th[data-col-rating="1"] { background-color: #f87171; color: #fff; }
        .modern-table thead th[data-col-rating="2"] { background-color: #fb923c; color: #fff; }
        .modern-table thead th[data-col-rating="3"] { background-color: #facc15; color: #fff; }
        .modern-table thead th[data-col-rating="4"] { background-color: #4ade80; color: #fff; }

        .modern-table tbody td {
            padding: 0.9rem 1.3rem; /* Match header padding */
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
            vertical-align: top;
            cursor: pointer;
            background: var(--table-cell-bg);
            line-height: 1.7; /* Improved line height for readability */
        }
        .modern-table tbody td:first-child { /* Sticky Category Name Column */
            position: sticky;
            left: 0;
            background: var(--table-cell-bg);
            z-index: 5;
            font-weight: 500;
             border-right: 1px solid var(--border); /* Add separator */
        }
        .modern-table tbody tr:last-child td { border-bottom: none; }

        .modern-table tbody tr:hover td { background-color: var(--table-cell-hover); }
        .modern-table tbody tr:hover td:first-child { background-color: var(--table-cell-hover); } /* Ensure sticky hover matches */

        .modern-table td.selected {
            background: var(--selected-highlight) !important;
            box-shadow: inset 3px 0 0 var(--selected-border);
        }
        .modern-table td:first-child.selected { /* Ensure sticky selected style */
             background: var(--selected-highlight) !important;
             box-shadow: inset 3px 0 0 var(--selected-border);
        }
         /* Subtle click effect */
        .modern-table td[data-rating]:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        .category-header strong { font-weight: 700; } /* Make category title slightly bolder */

        /* Section headers for groups */
        .section-header td {
            background: var(--table-header-bg);
            color: var(--text);
            text-align: left; /* Align left for consistency */
            font-size: 1.05rem; /* Slightly smaller */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            padding: 0.8rem 1.3rem; /* Adjusted padding */
            border-bottom: 2px solid var(--border);
        }
         .section-header:hover td { background-color: var(--table-cell-hover); }
         .section-header td i {
            margin-left: 10px;
            transition: transform 0.3s ease-out; /* Smoother transition */
            display: inline-block; /* Needed for transform */
         }
         .section-header.collapsed td i { transform: rotate(-90deg); }


        /* Collapsed Row Styling */
        tr.collapsed-row { display: none; }

        /* Feedback Panel */
        .feedback-panel label {
            font-weight: 500;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.95rem; /* Slightly larger label */
        }
        .feedback-input {
            display: block;
            width: 100%;
            box-sizing: border-box;
            min-height: 140px; /* Even taller text area */
            padding: 0.9rem 1.1rem; /* More padding */
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.6;
            transition: var(--transition);
            background-color: var(--input-bg);
            color: var(--text);
            margin-bottom: calc(var(--spacing) * 1.5); /* More space below */
            resize: vertical;
        }
        .feedback-input::placeholder { color: var(--placeholder-text); }
        /* input focus handled by global *:focus-visible */

        /* Legend & Definitions */
        #legend {
            font-size: 0.9rem;
            line-height: 1.6; /* Improved line height */
            /* Styles like background, border, padding now handled by .content-section wrapper */
        }
        #legend h4 { margin-top: 0; margin-bottom: 0.6rem; font-weight: 600; }
        #legend p { margin-bottom: 0.8rem; }
        #legend p:last-child { margin-bottom: 0; }
        #legend strong { font-weight: 700; } /* Bolder legend keywords */

        /* Modal Styles using <dialog> */
        .how-to-modal { /* Styles seem fine, maybe slightly larger padding */
             border: 1px solid var(--border); border-radius: var(--radius);
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); /* Slightly softer modal shadow */
             padding: calc(var(--spacing) * 2); /* More modal padding */
             max-width: 650px; background: var(--panel); color: var(--text);
        }
        .how-to-modal::backdrop { background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(4px); }
        .how-to-modal h2 { margin-top: 0; margin-bottom: 1.2rem; color: var(--primary-light); border-bottom: 1px solid var(--border); padding-bottom: 0.8rem; }
        .how-to-modal .modal-content { line-height: 1.7; }
        .how-to-modal .modal-content ol { padding-left: 1.5rem; }
         .how-to-modal .modal-content li { margin-bottom: 0.8rem; }
        .how-to-modal .close-btn {
            float: right; background: transparent; border: none; font-size: 1.6rem; color: var(--text);
            cursor: pointer; padding: 0.2rem; line-height: 1; opacity: 0.6; transition: opacity 0.2s ease;
        }
        .how-to-modal .close-btn:hover { opacity: 1; }

        /* Responsive */
        @media (max-width: 768px) {
            .analyzer-header { flex-direction: column; align-items: flex-start; gap: var(--spacing); }
            .header-right { width: 100%; justify-content: flex-start; } /* Align buttons left */
            .info-grid { grid-template-columns: 1fr; }
            .modern-table thead th { padding: 0.8rem 1rem; }
            .modern-table tbody td { padding: 0.8rem 1rem; }

            /* Ensure sticky columns still work visually on mobile */
            .modern-table thead th:first-child,
            .modern-table tbody td:first-child {
                background-clip: padding-box; /* Prevent bg bleed under border */
            }
             .modern-table thead th:first-child { background: var(--gradient); color: #fff; }
             .modern-table tbody td:first-child { background: var(--table-cell-bg); color: var(--text); }
             .modern-table tbody tr:hover td:first-child { background-color: var(--table-cell-hover); }
             .modern-table td:first-child.selected { background: var(--selected-highlight) !important; }
        }

    </style>
</head>
<body>
    <header class="analyzer-header"> <div class="header-left">
            <div class="site-title">
                <i class="fas fa-film" aria-hidden="true"></i>
                <span>Gaming Video Review</span>
            </div>
            <div class="total-score" id="scoreDisplay" tabindex="0" data-tooltip="Overall Score (0/76)">
                 <span id="scoreText">Overall (<span id="scoreTotal">0</span>/76)</span> – <span id="scoreLabel">Needs Work</span>
            </div>
            <div class="status-indicator" id="ranking" aria-live="polite">Incomplete</div>
        </div>
        <div class="header-right">
            <button class="btn" id="resetButton" aria-label="Reset Scores and Feedback">
                <i class="fas fa-sync-alt" aria-hidden="true"></i> Reset
            </button>
            <button class="btn" id="exportButton" aria-label="Export as PNG">
                <i class="fas fa-image" aria-hidden="true"></i> Export PNG
            </button>
            <button class="btn" id="howToButton" aria-label="How To Use">
                <i class="fas fa-question-circle" aria-hidden="true"></i> How To
            </button>
            <label class="toggle-label dark-mode-label" for="darkModeToggle" title="Toggle Dark/Light Mode">
                <input type="checkbox" id="darkModeToggle" aria-label="Toggle Dark Mode" />
                <div class="dark-mode-slider">
                    <span class="mode-icon">☀️</span>
                    <span class="mode-icon">🌙</span>
                    <div class="slider-thumb"></div>
                </div>
            </label>
        </div>
    </header>

    <main>
        <div class="analyzer-container">

            <section class="content-section video-info-panel" aria-labelledby="videoInfoHeading">
                <h2 id="videoInfoHeading">Video Information</h2>
                <div class="info-grid">
                    <div>
                        <label for="videoTitle">Video Title:</label>
                        <input type="text" id="videoTitle" name="videoTitle" placeholder="Enter the video title">
                    </div>
                    <div>
                        <label for="videoUrl">Video URL:</label>
                        <input type="url" id="videoUrl" name="videoUrl" placeholder="https://youtube.com/watch?v=...">
                    </div>
                    <div>
                        <label for="reviewerName">Reviewer Name:</label>
                        <input type="text" id="reviewerName" name="reviewerName" placeholder="Your name">
                    </div>
                </div>
            </section>

            <section class="content-section rubric-section" aria-labelledby="masterRubricHeading">
                 <h2 id="masterRubricHeading">Editing Review Rubric</h2>
                 <div class="rubric-table-wrapper">
                    <table class="modern-table" id="masterTable">
                        <thead>
                            <tr>
                                <th scope="col">Category</th>
                                <th scope="col" data-col-rating="1">1: Needs Improvement</th>
                                <th scope="col" data-col-rating="2">2: Fair</th>
                                <th scope="col" data-col-rating="3">3: Good</th>
                                <th scope="col" data-col-rating="4">4: Outstanding</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="section-header" data-group="g1" aria-expanded="true" tabindex="0">
                                <td colspan="5">Story & Structure <i class="fas fa-chevron-down" aria-hidden="true"></i></td>
                            </tr>
                            <tr data-group="g1" data-category-id="0">
                                <td data-category="0" class="category-header" scope="row"><strong>Hook & Opening Impact</strong></td>
                                <td data-category="0" data-rating="1">Opens with a slow, generic intro or idle footage<br>No clear reference to title/thumbnail promise<br>Viewers lack incentive to watch</td>
                                <td data-category="0" data-rating="2">Some attempt to mention the premise but takes 20–30 seconds<br>Hook is present but weakly tied to title/thumbnail</td>
                                <td data-category="0" data-rating="3">Clearly states or shows the challenge in the first 10–15 seconds<br>Uses a brief flash-forward or intriguing question</td>
                                <td data-category="0" data-rating="4">Grabs attention immediately (within 5–10 seconds)<br>Perfectly aligns with the title/thumbnail promise and creates a strong curiosity gap</td>
                            </tr>
                            <tr data-group="g1" data-category-id="1">
                                <td data-category="1" class="category-header" scope="row"><strong>Pacing & Momentum</strong></td>
                                <td data-category="1" data-rating="1">Long, uncut or boring segments<br>Extended silence/filler that drags</td>
                                <td data-category="1" data-rating="2">Some cuts remove dead air but pacing remains uneven<br>Noticeable slow spots</td>
                                <td data-category="1" data-rating="3">Frequent cuts eliminate most dull parts<br>Generally maintains viewer engagement with minor dips</td>
                                <td data-category="1" data-rating="4">Tight, purposeful editing throughout with minimal filler<br>Smoothly alternates fast action with brief breathers for contrast</td>
                            </tr>
                            <tr data-group="g1" data-category-id="2">
                                <td data-category="2" class="category-header" scope="row"><strong>Progression & Urgency</strong></td>
                                <td data-category="2" data-rating="1">No clear sense of progress or stakes<br>Feels aimless with random gameplay</td>
                                <td data-category="2" data-rating="2">States a goal but it's introduced late or not emphasized<br>Occasional updates that lack urgency</td>
                                <td data-category="2" data-rating="3">Clearly introduces a challenge early<br>Regularly shows progress or setbacks</td>
                                <td data-category="2" data-rating="4">Instantly establishes stakes with a “hero’s journey” narrative<br>Uses open loops and twists to sustain high viewer interest</td>
                            </tr>
                            <tr data-group="g1" data-category-id="3">
                                <td data-category="3" class="category-header" scope="row"><strong>Transitions & Flow</strong></td>
                                <td data-category="3" data-rating="1">Abrupt, confusing cuts<br>Time jumps with no explanation, disrupting immersion</td>
                                <td data-category="3" data-rating="2">Standard cuts that work most times but occasionally feel rough<br>Lacks context for major jumps</td>
                                <td data-category="3" data-rating="3">Smooth transitions (cutting on action or sound)<br>Uses simple text or fades to clarify time skips</td>
                                <td data-category="3" data-rating="4">Seamless transitions that enhance the narrative<br>Masterfully uses J-cuts, L-cuts, or bridging text for full immersion</td>
                            </tr>
                             <tr data-group="g1" data-category-id="4">
                                <td data-category="4" class="category-header" scope="row"><strong>Timing & Beat</strong></td>
                                <td data-category="4" data-rating="1">Poor timing; key moments cut off or linger awkwardly<br>No discernible rhythm</td>
                                <td data-category="4" data-rating="2">Some well-timed moments but overall inconsistency<br>Occasional issues with comedic or dramatic pacing</td>
                                <td data-category="4" data-rating="3">Generally good rhythm with effective comedic/dramatic beats<br>Uses brief breathers after intense sequences</td>
                                <td data-category="4" data-rating="4">Masterful timing that perfectly synchronizes edits with action and audio<br>Allows moments to breathe for maximum impact</td>
                            </tr>

                            <tr class="section-header" data-group="g2" aria-expanded="true" tabindex="0">
                                <td colspan="5">Visual Engagement <i class="fas fa-chevron-down" aria-hidden="true"></i></td>
                            </tr>
                             <tr data-group="g2" data-category-id="5">
                                <td data-category="5" class="category-header" scope="row"><strong>Visual Engagement & Graphics</strong></td>
                                <td data-category="5" data-rating="1">Over- or underuse of on-screen elements<br>Distracting or missing text/graphics</td>
                                <td data-category="5" data-rating="2">Some overlays or memes present but timing is off<br>Enhancements are inconsistent</td>
                                <td data-category="5" data-rating="3">Uses purposeful on-screen text, memes, or emojis<br>Enhances key points without overwhelming</td>
                                <td data-category="5" data-rating="4">Perfectly timed visual overlays that add clarity and humor<br>No clutter; every element serves the narrative</td>
                            </tr>
                             <tr data-group="g2" data-category-id="6">
                                <td data-category="6" class="category-header" scope="row"><strong>B‑Roll & Cutaways</strong></td>
                                <td data-category="6" data-rating="1">Stays on one continuous shot too long<br>No variety or illustrative inserts</td>
                                <td data-category="6" data-rating="2">Occasional cutaways, but feels sporadic and random</td>
                                <td data-category="6" data-rating="3">Regularly inserts relevant B‑roll or screenshots<br>Effectively clarifies commentary and breaks monotony</td>
                                <td data-category="6" data-rating="4">Skillfully uses B‑roll as pattern interrupts<br>Great variety that enhances both comprehension and entertainment</td>
                            </tr>
                            <tr data-group="g2" data-category-id="7">
                                <td data-category="7" class="category-header" scope="row"><strong>Zooms & Movement</strong></td>
                                <td data-category="7" data-rating="1">Static gameplay with no camera movement<br>Misses opportunities for emphasis</td>
                                <td data-category="7" data-rating="2">Occasional zoom-ins or pans but timing is weak<br>Movements feel random</td>
                                <td data-category="7" data-rating="3">Uses zooms effectively to highlight key or funny details<br>Generally smooth and purposeful</td>
                                <td data-category="7" data-rating="4">Masterful use of camera movement and zooms for dramatic or comedic effect<br>Always directs viewer attention with precision</td>
                            </tr>

                             <tr class="section-header" data-group="g3" aria-expanded="true" tabindex="0">
                                <td colspan="5">Audio <i class="fas fa-chevron-down" aria-hidden="true"></i></td>
                            </tr>
                            <tr data-group="g3" data-category-id="8">
                                <td data-category="8" class="category-header" scope="row"><strong>Audio – Music & Sound Design</strong></td>
                                <td data-category="8" data-rating="1">No music or mismatched tracks<br>Large volume imbalances and jarring audio cuts</td>
                                <td data-category="8" data-rating="2">Some background music present<br>Transitions are abrupt; commentary occasionally drowned out</td>
                                <td data-category="8" data-rating="3">Well-chosen music that fits the mood<br>Balanced levels and smooth audio transitions</td>
                                <td data-category="8" data-rating="4">Perfectly integrated music and sound effects<br>Expert volume mixing that heightens every scene</td>
                            </tr>
                            <tr data-group="g3" data-category-id="9">
                                <td data-category="9" class="category-header" scope="row"><strong>Emotional Cues & Reactions</strong></td>
                                <td data-category="9" data-rating="1">Flat or overly scripted commentary<br>No genuine reactions shown</td>
                                <td data-category="9" data-rating="2">Some natural reactions present but not emphasized<br>Creator’s personality is underutilized</td>
                                <td data-category="9" data-rating="3">Clearly shows genuine excitement, frustration, or humor<br>Facecam integrated effectively for real-time reactions</td>
                                <td data-category="9" data-rating="4">Strong, authentic emotional engagement<br>Editing amplifies reactions for a deep viewer connection</td>
                            </tr>
                             <tr data-group="g3" data-category-id="10">
                                <td data-category="10" class="category-header" scope="row"><strong>Music Choice & Impact</strong></td>
                                <td data-category="10" data-rating="1">Music does not match the tone; one track looped endlessly</td>
                                <td data-category="10" data-rating="2">Basic background music that somewhat fits<br>Rarely changes for scene shifts</td>
                                <td data-category="10" data-rating="3">Uses multiple tracks to reflect mood changes<br>Smooth transitions reinforce tension or excitement</td>
                                <td data-category="10" data-rating="4">Each segment’s music is perfectly curated to elevate emotion<br>Seamless transitions that feel cinematic</td>
                            </tr>
                            <tr data-group="g3" data-category-id="11">
                                <td data-category="11" class="category-header" scope="row"><strong>Sound FX & Audio Highlights</strong></td>
                                <td data-category="11" data-rating="1">No sound effects or overuse of random, distracting sounds</td>
                                <td data-category="11" data-rating="2">Minimal SFX usage; timing and volume are inconsistent</td>
                                <td data-category="11" data-rating="3">Fitting SFX boost key moments and humor<br>Balanced with overall audio</td>
                                <td data-category="11" data-rating="4">Expertly placed sound effects that punctuate action<br>Create memorable, engaging audio highlights</td>
                            </tr>

                            <tr class="section-header" data-group="g4" aria-expanded="true" tabindex="0">
                                <td colspan="5">Retention & Pattern <i class="fas fa-chevron-down" aria-hidden="true"></i></td>
                            </tr>
                            <tr data-group="g4" data-category-id="12">
                                <td data-category="12" class="category-header" scope="row"><strong>Retention Techniques</strong></td>
                                <td data-category="12" data-rating="1">No strong hook; dull segments with no re-engagement<br>Weak ending with no payoff</td>
                                <td data-category="12" data-rating="2">Decent intro but mid-video interest drops<br>Rarely uses open loops or foreshadowing</td>
                                <td data-category="12" data-rating="3">Solid start with a teased payoff<br>Some mid-video twist or re-hook present</td>
                                <td data-category="12" data-rating="4">Aggressive retention strategy with strong hook, multiple curiosity gaps<br>Climactic and rewarding ending</td>
                            </tr>
                             <tr data-group="g4" data-category-id="13">
                                <td data-category="13" class="category-header" scope="row"><strong>Pattern Interrupt & Layers</strong></td>
                                <td data-category="13" data-rating="1">Long stretches without any visual or auditory change<br>Repetitive content that bores the viewer</td>
                                <td data-category="13" data-rating="2">Occasional interrupts (zoom, meme) but predictable<br>Variety is present but not frequent</td>
                                <td data-category="13" data-rating="3">Regular use of cuts, text, or memes that refresh viewer attention<br>Switches between gameplay and reaction effectively</td>
                                <td data-category="13" data-rating="4">Masterful layering of interrupts (camera changes, SFX, on-screen captions)<br>Ensures no 20–30 second span goes without something fresh</td>
                             </tr>
                              <tr data-group="g4" data-category-id="14">
                                <td data-category="14" class="category-header" scope="row"><strong>Teasers / Open Loops</strong></td>
                                <td data-category="14" data-rating="1">No hint of upcoming highlights<br>No reason for viewers to stay</td>
                                <td data-category="14" data-rating="2">Brief mention of future excitement but underplayed<br>Payoff feels disconnected or delayed</td>
                                <td data-category="14" data-rating="3">Sets up curiosity early and teases key moments<br>Delivers on the promise later in the video</td>
                                <td data-category="14" data-rating="4">Multiple, well-timed teases and flash-forwards<br>Hook and re-engage viewers until the climactic payoff</td>
                            </tr>

                            <tr class="section-header" data-group="g5" aria-expanded="true" tabindex="0">
                                <td colspan="5">Overall Polish <i class="fas fa-chevron-down" aria-hidden="true"></i></td>
                            </tr>
                            <tr data-group="g5" data-category-id="15">
                                <td data-category="15" class="category-header" scope="row"><strong>Overall Engagement & Polish</strong></td>
                                <td data-category="15" data-rating="1">Video loses interest quickly; obvious editing gaps<br>Feels like raw footage with minimal polish</td>
                                <td data-category="15" data-rating="2">Watchable but lacks a “wow” factor<br>Minor technical issues or rough transitions present</td>
                                <td data-category="15" data-rating="3">Smooth, cohesive video with good storytelling and technical polish<br>Minimal errors and a professional feel</td>
                                <td data-category="15" data-rating="4">Engrossing from start to finish; technically flawless<br>Exudes a high-end, “pro YouTuber” production quality</td>
                             </tr>
                             <tr data-group="g5" data-category-id="16">
                                <td data-category="16" class="category-header" scope="row"><strong>Surprise & Unexpected</strong></td>
                                <td data-category="16" data-rating="1">Predictable flow with no unexpected edits or twists</td>
                                <td data-category="16" data-rating="2">Occasional surprises, but nothing that stands out</td>
                                <td data-category="16" data-rating="3">Deliberate inclusion of small surprises or comedic inserts<br>Keeps the video feeling fresh</td>
                                <td data-category="16" data-rating="4">Packed with well-timed, organic surprises that reignite viewer excitement throughout</td>
                             </tr>
                             <tr data-group="g5" data-category-id="17">
                                <td data-category="17" class="category-header" scope="row"><strong>Tone & Style Fit</strong></td>
                                <td data-category="17" data-rating="1">Editing style clashes with the channel’s personality<br>Overly dramatic or too bland</td>
                                <td data-category="17" data-rating="2">Somewhat aligned but inconsistently executed<br>Minor mismatches in tone</td>
                                <td data-category="17" data-rating="3">Editing style complements the content and creator’s personality<br>Consistent mood throughout</td>
                                <td data-category="17" data-rating="4">Cohesive and unmistakable style that perfectly suits the content<br>Viewers instantly recognize the polished brand identity</td>
                             </tr>
                             <tr data-group="g5" data-category-id="18">
                                <td data-category="18" class="category-header" scope="row"><strong>Technical Polish & Finishing</strong></td>
                                <td data-category="18" data-rating="1">Frequent audio pops, glitchy transitions, and inconsistent color/volume<br>Looks like a rough draft</td>
                                <td data-category="18" data-rating="2">Basic corrections applied but minor issues remain<br>Some synchronization or export flaws</td>
                                <td data-category="18" data-rating="3">Clean, error-free timeline with proper color correction and audio mixing<br>High-resolution export that looks professional</td>
                                <td data-category="18" data-rating="4">Impeccable finishing: zero stray frames, perfect crossfades, and flawless technical polish<br>Expert use of editing tools for a refined final product</td>
                             </tr>

                        </tbody>
                    </table>
                </div>
            </section>

             <section class="content-section feedback-panel" aria-labelledby="feedbackHeading">
                <h2 id="feedbackHeading">Review Feedback</h2>
                <div class="feedback-entry">
                    <label for="specificFeedback">Specific Feedback (Mention Category or Timestamp):</label>
                    <textarea
                        id="specificFeedback"
                        class="feedback-input"
                        placeholder="e.g., 'Hook (0:05): Could be faster.' or 'Audio (3:10): Music too loud here.'"
                    ></textarea>
                </div>
                 <div class="feedback-entry">
                    <label for="overallFeedback">Overall Summary & Suggestions:</label>
                    <textarea
                        id="overallFeedback"
                        class="feedback-input"
                        placeholder="General thoughts, main strengths, key areas for improvement..."
                    ></textarea>
                </div>
            </section>

            <section class="content-section legend-panel" aria-labelledby="legendHeading">
                <h2 id="legendHeading">Rating Legend</h2>
                <div id="legend">
                    <p><strong>Needs Improvement (1pt):</strong> Major issues hindering viewer experience or retention. Requires significant revision.</p>
                    <p><strong>Fair (2pts):</strong> Functional but lacks polish or impact. Meets minimum expectations but doesn't excel.</p>
                    <p><strong>Good (3pts):</strong> Solid execution, meets expectations well. Minor areas for improvement may exist.</p>
                    <p><strong>Outstanding (4pts):</strong> Exceeds expectations, demonstrates strong skill and polish. Highly effective and engaging.</p>
                </div>
            </section>

        </div></main>

    <dialog id="howToModal" class="how-to-modal">
         <button class="close-btn" id="closeModalButton" aria-label="Close dialog">×</button>
        <h2>How To Use This Rubric</h2>
        <div class="modal-content">
            <ol>
                <li>Fill in the <strong>Video Information</strong> section (Title, URL, Reviewer).</li>
                <li>Review the video content based on the criteria in the <strong>Editing Review Rubric</strong> table.</li>
                <li>Click the cell in each row that best describes the video's performance for that category (Needs Improvement, Fair, Good, or Outstanding). The score automatically updates.</li>
                 <li>Use the <i class="fas fa-chevron-down"></i> icons on section headers (like "Story & Structure") to collapse/expand groups of criteria if needed.</li>
                <li>Provide detailed notes in the <strong>Review Feedback</strong> section. Use "Specific Feedback" for targeted comments and "Overall Summary" for general thoughts.</li>
                <li>The <strong>Total Score</strong> (out of 76) and <strong>Ranking</strong> update automatically in the header.</li>
                <li>Use the <strong>Reset</strong> button to clear all selections and feedback.</li>
                <li>Use the <strong>Export PNG</strong> button to save an image of the review (including video info, rubric selections, and feedback).</li>
                 <li>Toggle <strong>Dark/Light Mode</strong> using the ☀️/🌙 switch.</li>
            </ol>
        </div>
    </dialog>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const masterTable = document.getElementById('masterTable');
            const scoreTotalEl = document.getElementById('scoreTotal');
            const scoreLabelEl = document.getElementById('scoreLabel');
            const scoreDisplayEl = document.getElementById('scoreDisplay');
            const scoreTextEl = document.getElementById('scoreText');
            const rankingEl = document.getElementById('ranking');
            const resetButton = document.getElementById('resetButton');
            const exportButton = document.getElementById('exportButton');
            const howToButton = document.getElementById('howToButton');
            const closeModalButton = document.getElementById('closeModalButton');
            const howToModal = document.getElementById('howToModal');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const specificFeedback = document.getElementById('specificFeedback');
            const overallFeedback = document.getElementById('overallFeedback');
            const videoTitleInput = document.getElementById('videoTitle');
            const videoUrlInput = document.getElementById('videoUrl');
            const reviewerNameInput = document.getElementById('reviewerName');

            // --- Configuration ---
            const MAX_SCORE_PER_CATEGORY = 4;
            const TOTAL_CATEGORIES = 19; // Categories 0-18
            const MAX_POSSIBLE_SCORE = TOTAL_CATEGORIES * MAX_SCORE_PER_CATEGORY; // 19 * 4 = 76

            // Register dialog polyfill if needed
             if (typeof dialogPolyfill !== 'undefined') {
                 dialogPolyfill.registerDialog(howToModal);
             }

             // --- State ---
            let scores = {}; // Stores { categoryId: rating }
            let confettiShown = false; // Track if confetti has been shown for the current score


            // --- Functions ---

            // Calculate and Update Score Display
            function calculateAndUpdateScore() {
                let currentTotal = 0;
                let categoriesScored = 0;

                // Iterate through defined categories (0-18) to ensure count is accurate
                 for (let i = 0; i < TOTAL_CATEGORIES; i++) {
                     const categoryId = i.toString();
                     if (scores.hasOwnProperty(categoryId) && scores[categoryId] > 0) {
                        currentTotal += scores[categoryId];
                        categoriesScored++;
                     }
                 }

                 // Update score text in header
                scoreTotalEl.textContent = currentTotal;
                scoreTextEl.textContent = `Overall (<span class="math-inline">\{currentTotal\}/</span>{MAX_POSSIBLE_SCORE})`;
                scoreDisplayEl.setAttribute('data-tooltip', `Overall Score (<span class="math-inline">\{currentTotal\}/</span>{MAX_POSSIBLE_SCORE})`);

                // Determine label and ranking
                let label = 'Needs Work';
                let ranking = 'Incomplete';
                const percentage = MAX_POSSIBLE_SCORE > 0 ? (currentTotal / MAX_POSSIBLE_SCORE) * 100 : 0;

                if (categoriesScored === TOTAL_CATEGORIES) { // Check if all 19 categories are scored
                     ranking = `Final Score: ${percentage.toFixed(0)}% - `;
                     if (percentage >= 90) {
                        label = 'Outstanding';
                        ranking += 'Excellent - Ready to Publish!';
                        if (!confettiShown) {
                           triggerConfetti();
                           confettiShown = true;
                        }
                    } else if (percentage >= 75) {
                        label = 'Good';
                         ranking += 'Solid - Minor tweaks optional.';
                         confettiShown = false;
                    } else if (percentage >= 50) {
                        label = 'Fair';
                         ranking += 'Okay - Consider revisions.';
                         confettiShown = false;
                    } else {
                        label = 'Needs Work';
                        ranking += 'Needs Significant Improvement.';
                        confettiShown = false;
                    }
                } else if (categoriesScored > 0) {
                     ranking = `In Progress (<span class="math-inline">\{categoriesScored\}/</span>{TOTAL_CATEGORIES} rated)`;
                      if (percentage >= 75) label = 'Good';
                      else if (percentage >= 50) label = 'Fair';
                      else label = 'Needs Work';
                      confettiShown = false;
                 } else {
                     label = 'Not Started';
                     ranking = 'Incomplete';
                     confettiShown = false;
                 }


                scoreLabelEl.textContent = label;
                rankingEl.textContent = ranking;

                 saveState();
             }

             // Handle Cell Click
            function handleCellClick(event) {
                const target = event.target.closest('td');
                if (!target || !target.dataset.category || !target.dataset.rating) return;

                 const categoryId = target.dataset.category;
                 const rating = parseInt(target.dataset.rating, 10);
                 const row = target.parentElement;

                // Deselect other cells in the same row
                 row.querySelectorAll('td[data-rating]').forEach(cell => {
                    cell.classList.remove('selected');
                 });

                 target.classList.add('selected');
                 scores[categoryId] = rating;

                 calculateAndUpdateScore();
            }

             // Reset Function
            function resetAll() {
                if (!confirm('Are you sure you want to reset all scores and feedback?')) return;
                 initializeScores(); // Reset scores object correctly

                 masterTable.querySelectorAll('tbody td.selected').forEach(cell => {
                     cell.classList.remove('selected');
                 });
                 videoTitleInput.value = '';
                 videoUrlInput.value = '';
                 reviewerNameInput.value = '';
                 specificFeedback.value = '';
                 overallFeedback.value = '';
                 confettiShown = false;

                 calculateAndUpdateScore();
                 localStorage.removeItem('reviewAppState');
             }

            // Export as PNG
            function exportPNG() {
                const mainElement = document.querySelector('main');
                 const headerElement = document.querySelector('.analyzer-header');

                 const options = {
                     scale: 1.5, useCORS: true,
                     backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim() || '#ffffff',
                     logging: false, windowWidth: 1400, windowHeight: document.documentElement.scrollHeight
                 };

                 const collapsedSections = document.querySelectorAll('.section-header.collapsed');
                 collapsedSections.forEach(header => toggleSection(header, true)); // Force expand

                 const exportContainer = document.createElement('div');
                 exportContainer.style.padding = '1rem';
                 exportContainer.style.backgroundColor = options.backgroundColor;
                 const clonedHeader = headerElement.cloneNode(true);
                 const clonedMain = mainElement.cloneNode(true);
                 exportContainer.appendChild(clonedHeader);
                 exportContainer.appendChild(clonedMain);

                 exportContainer.style.position = 'absolute';
                 exportContainer.style.left = '-9999px';
                 exportContainer.style.top = '-9999px';
                 exportContainer.style.width = `${options.windowWidth}px`;
                 document.body.appendChild(exportContainer);

                 setTimeout(() => { // Timeout helps ensure styles are rendered for capture
                     html2canvas(exportContainer, options).then(canvas => {
                         const link = document.createElement('a');
                         const timestamp = new Date().toISOString().slice(0, 16).replace(/[:T]/g, '-');
                         const title = (videoTitleInput.value || 'video-review').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                         link.download = `<span class="math-inline">\{title\}\_review\_</span>{timestamp}.png`;
                         link.href = canvas.toDataURL('image/png');
                         link.click();
                         document.body.removeChild(exportContainer);
                         collapsedSections.forEach(header => toggleSection(header, false));
                     }).catch(err => {
                         console.error("Error exporting PNG:", err);
                         alert("Could not export PNG. See console for details.");
                         if (document.body.contains(exportContainer)) {
                             document.body.removeChild(exportContainer);
                         }
                         collapsedSections.forEach(header => toggleSection(header, false));
                     });
                 }, 150); // Increased delay slightly
            }

            // Toggle Dark/Light Theme
            function toggleTheme(isDark) {
                if (isDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                }
            }

             // Trigger Confetti
             function triggerConfetti() {
                 if (typeof confetti === "function") {
                     confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                 }
             }

             // Modal Handling
            function openHowTo() { howToModal.showModal(); }
            function closeHowTo() { howToModal.close(); }

              // Section Collapse/Expand
            function toggleSection(headerElement, forceExpand = null) {
                 const group = headerElement.dataset.group;
                 if (!group) return;
                 const rowsToToggle = masterTable.querySelectorAll(`tbody tr[data-group="${group}"]:not(.section-header)`);
                 const icon = headerElement.querySelector('i.fa-chevron-down, i.fa-chevron-right');
                 let isCollapsed = (forceExpand !== null) ? !forceExpand : headerElement.classList.contains('collapsed');

                 if (isCollapsed) { // Expand
                    headerElement.classList.remove('collapsed');
                    headerElement.setAttribute('aria-expanded', 'true');
                    if(icon) icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
                    rowsToToggle.forEach(row => row.classList.remove('collapsed-row'));
                 } else { // Collapse
                     headerElement.classList.add('collapsed');
                     headerElement.setAttribute('aria-expanded', 'false');
                     if(icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
                     rowsToToggle.forEach(row => row.classList.add('collapsed-row'));
                 }
            }

             // --- State Persistence (localStorage) ---
             function saveState() {
                 const state = {
                     scores: scores, videoTitle: videoTitleInput.value, videoUrl: videoUrlInput.value,
                     reviewerName: reviewerNameInput.value, specificFeedback: specificFeedback.value, overallFeedback: overallFeedback.value
                 };
                 try { localStorage.setItem('reviewAppState', JSON.stringify(state)); }
                 catch (e) { console.error("Could not save state:", e); }
             }

             function loadState() {
                 const savedState = localStorage.getItem('reviewAppState');
                 if (savedState) {
                     try {
                        const state = JSON.parse(savedState);
                         initializeScores(); // Initialize scores object first
                         // Load scores from saved state
                         if (state.scores) {
                             for (let i = 0; i < TOTAL_CATEGORIES; i++) {
                                 const categoryId = i.toString();
                                 scores[categoryId] = state.scores[categoryId] || 0;
                             }
                         }

                         videoTitleInput.value = state.videoTitle || '';
                         videoUrlInput.value = state.videoUrl || '';
                         reviewerNameInput.value = state.reviewerName || '';
                         specificFeedback.value = state.specificFeedback || '';
                         overallFeedback.value = state.overallFeedback || '';

                         masterTable.querySelectorAll('tbody td[data-category][data-rating]').forEach(cell => {
                             const categoryId = cell.dataset.category;
                             const rating = parseInt(cell.dataset.rating, 10);
                             cell.classList.toggle('selected', scores[categoryId] === rating);
                         });
                         calculateAndUpdateScore();
                     } catch (e) {
                         console.error("Error loading state:", e);
                         localStorage.removeItem('reviewAppState');
                         initializeScores();
                         calculateAndUpdateScore();
                     }
                 } else {
                     initializeScores();
                     calculateAndUpdateScore();
                 }
             }

             function initializeScores() {
                 scores = {};
                 for (let i = 0; i < TOTAL_CATEGORIES; i++) { scores[i.toString()] = 0; }
                 confettiShown = false;
             }


            // --- Event Listeners ---
            masterTable.querySelector('tbody').addEventListener('click', handleCellClick);
            resetButton.addEventListener('click', resetAll);
            exportButton.addEventListener('click', exportPNG);
            howToButton.addEventListener('click', openHowTo);
            closeModalButton.addEventListener('click', closeHowTo);
            howToModal.addEventListener('click', (event) => { if (event.target === howToModal) closeHowTo(); });
            darkModeToggle.addEventListener('change', (event) => toggleTheme(event.target.checked));

            masterTable.querySelectorAll('.section-header').forEach(header => {
                 header.addEventListener('click', () => toggleSection(header));
                 header.addEventListener('keydown', (event) => { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); toggleSection(header); }});
                 // Initialize icons correctly
                 const icon
