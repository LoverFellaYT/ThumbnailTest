<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StoryCraft Analyzer Pro+ Enhanced</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js" defer></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnH/PRRZ9i6Lkxy/lK+Ad+Qw3PweIIsXgTn5N2sA3ZgP6L6YKn42pPZLNSQNkI3b7HlFj5pAg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Google Font: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS Styles -->
    <style>
      /* --------------------------------------------------------------
         CSS Variables & Base Styles
         -------------------------------------------------------------- */
      :root {
        --primary-light: #4facfe;
        --accent-light: #00f2fe;
        --bg-light: #f9fafb;
        --text-light: #1e293b;
        --panel-light: rgba(255, 255, 255, 0.96);
        --border-light: rgba(255, 255, 255, 0.2);
        --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        --transition: all 0.2s ease;
        --radius: 14px;
        --gradient-light: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%);
        --spacing: 1rem;
        --font-base: 'Roboto', sans-serif;
        --table-cell-bg-light: rgba(255, 255, 255, 0.85);
      }
      html[data-theme="dark"] {
        --bg-light: #1f1f1f;
        --text-light: #f3f3f3;
        --panel-light: rgba(18, 18, 18, 0.98);
        --border-light: rgba(255, 255, 255, 0.2);
        --gradient-light: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --table-cell-bg-light: rgba(30, 30, 30, 0.85);
      }
      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-base);
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px), var(--bg-light);
        background-size: 30px 30px;
        color: var(--text-light);
        transition: var(--transition);
      }
      /* Container to center and narrow the content */
      .analyzer-container {
        width: 95%;
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 var(--spacing) 2rem;
        text-align: center;
      }
      /* --------------------------------------------------------------
         Header / Sticky Banner
         -------------------------------------------------------------- */
      header.analyzer-header {
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: 1.5rem 2rem;
        margin-bottom: var(--spacing);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--panel-light);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        animation: headerGlow 3s infinite alternate;
      }
      @keyframes headerGlow {
        from { box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        to { box-shadow: 0 0 30px rgba(255,215,0,1); }
      }
      .header-left {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        text-align: center;
      }
      .total-score {
        font-size: 1.75rem;
        font-weight: 700;
        background: var(--gradient-light);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .progress-bar-container {
        width: 100%;
        height: 6px;
        background: #eee;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: var(--gradient-light);
        transition: width 0.3s ease;
      }
      .status-indicator {
        font-weight: 600;
      }
      .header-right {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }
      /* --------------------------------------------------------------
         Dark Mode Toggle Styles
         -------------------------------------------------------------- */
      .dark-mode {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
      }
      .toggle-label {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
      }
      .dark-mode-slider {
        position: relative;
        width: 60px;
        height: 30px;
        background-color: #e0e0e0;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 5px;
        transition: background-color 0.3s;
      }
      .dark-mode-slider .mode-label {
        font-size: 16px;
        user-select: none;
      }
      .dark-mode-slider .slider-thumb {
        position: absolute;
        width: 26px;
        height: 26px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }
      input#darkModeToggle {
        display: none;
      }
      input#darkModeToggle:checked + .dark-mode-slider .slider-thumb {
        transform: translateX(30px);
      }
      input#darkModeToggle:checked + .dark-mode-slider {
        background-color: var(--primary-light);
      }
      /* --------------------------------------------------------------
         Button Styling
         -------------------------------------------------------------- */
      button.btn {
        background: var(--gradient-light);
        color: #fff;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px rgba(126, 34, 206, 0.2);
      }
      button.btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(126, 34, 206, 0.4);
      }
      /* Rainbow Button as a Rainbow Emoji */
      button.rainbow-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
      }
      button.rainbow-btn:hover {
        transform: scale(1.2);
      }
      /* --------------------------------------------------------------
         Glass Panels for Sections
         -------------------------------------------------------------- */
      .glass-panel {
        background: var(--panel-light);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        padding: 2rem;
        margin: 1rem 0;
        text-align: center;
      }
      .glass-panel h2 {
        margin-top: 0;
        text-align: center;
      }
      /* --------------------------------------------------------------
         Input Areas & Textarea Styling
         -------------------------------------------------------------- */
      .input-section {
        margin: 1rem 0;
      }
      .story-input {
        width: 100%;
        min-height: 120px;
        padding: 1rem;
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
        font-size: 1rem;
        background: var(--bg-light);
        resize: none;
        transition: var(--transition);
        margin-bottom: 0.5rem;
      }
      .story-input:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
      }
      input[type="text"] {
        padding: 0.5rem;
        width: 70%;
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
      }
      /* --------------------------------------------------------------
         Similar Videos Section
         -------------------------------------------------------------- */
      .similar-videos-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
      }
      .video-thumbnail {
        width: 200px;
        overflow: hidden;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
      }
      .video-thumbnail img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
      }
      .video-title {
        padding: 0.5rem;
        font-size: 0.9rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0 4px;
        line-height: 1;
      }
      .video-thumbnail:hover {
        transform: scale(1.02);
      }
      /* --------------------------------------------------------------
         Rubric Table Styling
         -------------------------------------------------------------- */
      .rubric-table {
        overflow-x: auto;
        margin: 1rem 0;
      }
      .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 800px;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
      }
      .modern-table th {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        text-align: left;
        position: sticky;
        top: 0;
        backdrop-filter: blur(10px);
        z-index: 10;
        background: var(--gradient-light);
        color: #fff;
      }
      .modern-table th:nth-child(2) { background: #f87171; color: #fff; }
      .modern-table th:nth-child(3) { background: #fb923c; color: #fff; }
      .modern-table th:nth-child(4) { background: #facc15; color: #000; }
      .modern-table th:nth-child(5) { background: #4ade80; color: #fff; }
      .modern-table td {
        padding: 0.75rem 1.5rem;
        background: var(--table-cell-bg-light);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        transition: var(--transition);
        vertical-align: top;
      }
      .modern-table td:hover:not(.category-header) {
        background: rgba(224, 231, 255, 0.3);
      }
      .modern-table td.selected {
        background: rgba(224, 231, 255, 0.5) !important;
        border-left: 4px solid var(--primary-light);
      }
      .category-header {
        font-weight: 600;
        background: rgba(79, 172, 254, 0.03);
        position: sticky;
        left: 0;
        min-width: 180px;
      }
      /* --------------------------------------------------------------
         Self-Assessment Checklist Styling
         -------------------------------------------------------------- */
      #selfAssessmentSection ul {
        list-style-type: none;
        padding: 0;
        margin: 0 auto;
        max-width: 600px;
        text-align: left;
      }
      #selfAssessmentSection li {
        margin-bottom: 0.5rem;
      }
      #selfAssessmentSection li label {
        cursor: pointer;
      }
      @media (max-width: 768px) {
        header.analyzer-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .header-right {
          margin-top: 1rem;
          width: 100%;
          justify-content: space-around;
        }
      }
    </style>
  </head>
  <body>
    <div class="analyzer-container">
      <!-- HEADER / Sticky Banner -->
      <header class="analyzer-header">
        <div class="header-left">
          <div class="total-score">
            Score: <span id="total">0</span>/40 <span id="scoreLabel">Incomplete</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
          <div class="status-indicator" id="ranking">Incomplete</div>
        </div>
        <div class="header-right">
          <button class="btn" id="resetBtn">üîÑ Reset</button>
          <button class="btn" id="exportBtn">üñºÔ∏è Export PNG</button>
          <button class="btn rainbow-btn" id="rainbowBtn">üåà</button>
          <!-- Dark Mode Toggle -->
          <div class="dark-mode">
            <label class="toggle-label">
              <input type="checkbox" id="darkModeToggle" />
              <div class="dark-mode-slider">
                <div class="slider-thumb"></div>
              </div>
            </label>
          </div>
        </div>
      </header>

      <!-- MAIN CONTENT -->
      <main>
        <!-- Quick Summary Section -->
        <div class="glass-panel input-section" id="quickSummarySection">
          <h2>üìù Quick Summary</h2>
          <textarea id="quickSummary" class="story-input" placeholder="Summarize the story or video in a few lines..."></textarea>
        </div>

        <!-- Similar Videos Section -->
        <div class="glass-panel input-section" id="similarVideosSection">
          <h2>üì∫ Similar Videos</h2>
          <input type="text" id="youtubeLinkInput" placeholder="Enter YouTube video URL..." />
          <button class="btn" id="addVideoBtn">Add Video</button>
          <div id="similarVideosList" class="similar-videos-list"></div>
        </div>

        <!-- AI Review Section -->
        <div class="glass-panel input-section" id="aiReviewSection">
          <h2>ü§ñ AI Review</h2>
          <button class="btn" id="runAIReviewBtn">Run AI Review</button>
          <div id="aiReviewResult" style="margin-top: 1rem;"></div>
        </div>

        <!-- Rubric Table Section -->
        <div class="glass-panel rubric-table" id="rubricSection">
          <h2>üìä Rubric Table</h2>
          <table class="modern-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Good (1)</th>
                <th>Great (2)</th>
                <th>Excellent (3)</th>
                <th>Outstanding (4)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="category-header" data-category="0" title="The opener should immediately grab attention.">Hook &amp; Opening</td>
                <td data-category="0" data-rating="1">Slow start; no hook</td>
                <td data-category="0" data-rating="2">Basic hook</td>
                <td data-category="0" data-rating="3">Intriguing hook</td>
                <td data-category="0" data-rating="4">Unignorable opener</td>
              </tr>
              <!-- ... Additional rubric rows ... -->
              <tr>
                <td class="category-header" data-category="13" title="Balanced pacing keeps the reader hooked.">Pacing &amp; Rhythm</td>
                <td data-category="13" data-rating="1">Story drags; uneven pace</td>
                <td data-category="13" data-rating="2">Some parts drag‚Äîreview transitions</td>
                <td data-category="13" data-rating="3">Generally well‚Äëpaced</td>
                <td data-category="13" data-rating="4">Flawless pacing that maintains tension</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Human Feedback Section -->
        <div class="glass-panel input-section" id="humanFeedbackSection">
          <h2>üë• Human Feedback</h2>
          <textarea id="humanFeedback" class="story-input" placeholder="Add your own notes and feedback here..." style="min-height: 100px;"></textarea>
        </div>

        <!-- Peer Reviews Section -->
        <div class="glass-panel input-section" id="peerReviewSection">
          <h2>üí¨ Peer Reviews</h2>
          <input type="text" id="peerReviewUsername" placeholder="Enter your username..." />
          <textarea id="peerReviewInput" class="story-input" placeholder="Enter your peer review comment..."></textarea>
          <button class="btn" onclick="submitPeerReview()">Submit Peer Review</button>
          <ul id="peerReviewList" class="peer-review-list"></ul>
        </div>
      </main>
    </div>

    <!-- JavaScript -->
    <script>
      // Global variables
      let scores = {};
      let peerReviews = [];

      // Function to randomly show a rainbow quote
      function showRainbowQuote() {
        const randomQuote = storyQuotes[Math.floor(Math.random() * storyQuotes.length)];
        alert(randomQuote);
      }

      // Attach event listeners once DOM is loaded
      window.addEventListener('DOMContentLoaded', () => {
        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('change', toggleTheme);
        // Export PNG button
        document.getElementById('exportBtn').addEventListener('click', exportPNG);
        // Rainbow quote button
        document.getElementById('rainbowBtn').addEventListener('click', showRainbowQuote);
        // Rubric cell clicks
        document.querySelectorAll('.modern-table td[data-rating]').forEach(cell => {
          cell.addEventListener('click', () => selectRating(cell));
        });
        // Auto-resize textareas
        document.querySelectorAll('.story-input').forEach(textarea => {
          textarea.addEventListener('input', autoResize);
        });
        // AI Review button click
        document.getElementById('runAIReviewBtn').addEventListener('click', runAIReview);
      });

      // Array of rainbow quotes
      const storyQuotes = [
        "The test of good writing and good story is: does it not only reward the first viewing, but also the second viewing?",
        "Movies are all about the last ten minutes\nTools, not rules",
        "When the climax is established, work backwards and ask \"if this scene was removed, would the climax still work? If it would still work, remove that scene\"",
        "Research wins the war on cliche",
        "When you do enough research, the story writes itself. Lines spring loose and you'll have choices galore.\nWriting is discipline, writing movies is a drill sergeant",
        "The inciting incident should radically upset the balance of forces in the protagonist's life",
        "If the story you're telling is the story you're telling, you're in deep shit. (this one is soooo good, read it again)",
        "Avoid pace killers ‚Äì as in, a character doing a fully expected action, such as walking into a house",
        "Stories can fail either because there is meaningless conflict, or not enough meaningful and honestly expressed conflict.",
        "The longer the story - more need for more turning points or acts. A two hour film needs at least three major reversals. Middle act (often act 2) should be the longest. Act 3 the shortest",
        "Two people have to disagree on something for there to be a scene (Conflict)",
        "A subplot can elevate a boring film into an interesting one",
        "A subplot can be a variation on a theme, or resonate the main idea - or complicate the main plot. But unless subplot compliments main plot, it will tear the story down the middle",
        "Do not repeat emotions - audience impact will be reduced.",
        "Choices of characters must not be doubt but dilemma - not between right and wrong, or good and evil, but between either positive desires or negative desires of equal weight and value.",
        "You need a new scene every 2-3 mins to keep audiences engaged. But that doesn't mean a new backdrop - it could be her mother enters a garden where a couple are talking, which changes the dynamic. Or it could be areas of a room.",
        "Climax: meaning produces emotion. Not money, SFX, etc",
        "The key to all story endings: give the audience what it wants, but not the way it expects",
        "The depth of our joy is in direct proportion of what we've suffered. Holocaust survivors don't avoid dark films - they go because such stories resonate with their past and are deeply cathartic. Go for a 'slow curtain' close.",
        "Principle of antagonism: a protagonist and his story are only as fascinating and compelling as the forces of antagonism make them.",
        "Vast majority don't care if a film has a happy or sad ending. They instead want emotional satisfaction - a climax that fulfils anticipation",
        "Give the emotion you promised - but with unexpected insight",
        "Try to climax with a single memorable image on screen",
        "Parse out exposition, bit by bit, through the entire story. Don't try to 'get it all out the way at first'.",
        "You don't keep the audience's interest by giving in info, but instead by withholding it. Critical pieces of exposition are secrets.",
        "Reveal only exposition your audience needs to know, or wants to know",
        "Stories are hard when a character has nothing to lose.",
        "Make exposition your ammunition. Avoid unmotivated exposition, like one maid telling the other about a history of the house",
        "Dream sequences are seldom effective.",
        "Narration/voice-over: should be economical, and should not be a way to substitute poor storytelling. Narration can add wit, ironies, and insight",
        "A good advice for writing film dialogue: don't. See if you can visually express it... make the audience hungry for dialogue. Write for the eye. Dialogue is the last, regretful element we add to the story.",
        "External imagery is the hallmark of a student film. Aim for internal imagery. Internal images are something like the use of water, outdoor spaces associated with character, etc. Windows in Chinatown",
        "Image system must be subliminal - audience must not be aware of it. Symbolism moves and touches us - as long as we don't regard it as symbolic. Awareness of a symbol turns it into a neutral, intellectual curiosity. Declamatory symbolism is vanity that demeans and corrupts the art.",
        "The more you repeat something - an emotion, edit, etc - the less impact it has.",
        "Your protagonist needs to be the one who makes the decision that brings about the climactic action.",
        "Set yourself creative limitations, because they will inspire you and help you with your writing.",
        "You reveal a character‚Äôs hidden nature by putting them under pressure.",
        "Desire in your character is key.",
        "You can do whatever you want in your movie, as long as you make sure it works and you know why you‚Äôre doing it.",
        "Create dimensionality in characters by building consistent contradictions within them.",
        "When you don't know what to write about, ask yourself what your favorite movies are and why they are your favorite.",
        "Character payoffs should always be emotional unless you have a special reason.",
        "There Is No Story Unless A Bad Situation Gets Worse ‚Äì John Vorhaus",
        "If The Logline Doesn‚Äôt Work The Story Doesn‚Äôt Work ‚Äì Jen Grisanti",
        "If you don't know the ending before you start, you are inviting writer's block",
        "Step outline: to work on a movie, spend two thirds of your time working out a step outline: the story told in steps. Steps describe what happens in each scene. For example: 'He enters expecting to find her home, but discovers a note saying she's gone for good.' Assign scenes to each step, like 'inciting incident', 'first act climax', 'mid act climax', etc. Do this for central plot and subplots.",
        "Treatment: is heavily expanded from the step outline. No need for dialogue; instead, add subtext and what characters want to get out of the scene. 'He's surprised by his outburst, but glad that he can still feel emotion.'",
        "Screenplay: writing a screenplay from a thorough treatment is a joy, you can maybe write several pages a day. We convert treatment description to screen description, and add dialogue. Our characters can finally talk, after being silent for so long! You may have to rework screenplay and alter direction here.",
        "Realize 90 percent of what you write is nonsense or mediocre. So you need to create far more material than you need, then destroy it. There's no limit to what you can create, so trash what's less than best.",
        "Master your craft. Don't just take your talent for a walk.",
        "When the audience no longer has to figure out the story, it ceases being an audience, and the story stops.",
        "90% of writers fail at the premise. If the premise is weak, there is nothing you can do to save the story.",
        "Show your hero's flaw early, and let their journey be about confronting and overcoming it.",
        "Every scene should either challenge your character or change them ‚Äì preferably both.",
        "Introduce the stakes as early as possible, so the audience knows what could be lost and roots for the hero.",
        "Create a 'Save the Cat' moment where the protagonist does something likable or relatable, forging a bond with the audience.",
        "Let your antagonist be a mirror to your protagonist‚Äôs flaw, thereby intensifying their journey towards growth.",
        "Incorporate a theme stated moment early on, where the story's deeper message is subtly revealed.",
        "Ensure every character has a distinct voice and purpose, contributing uniquely to the story‚Äôs progression.",
        "Use the midpoint to shift gears: deepen the conflict, raise stakes, or twist the story in an unexpected direction.",
        "Balance external action with internal growth; the plot should drive the character's emotional journey and vice versa.",
        "Your ending should pay off not just the plot but the emotional and thematic journey of your protagonist.",
        "Rewrite with purpose: every draft should sharpen your protagonist's arc and clarify the story's central theme.",
        "Keep the audience in mind ‚Äì craft moments of empathy, suspense, and surprise to engage them emotionally.",
        "Don‚Äôt just resolve the plot; ensure your character‚Äôs transformation is complete and satisfying by the story‚Äôs end.",
        "Foreshadowing is key: plant early seeds that make the climax feel inevitable yet surprising.",
        "Balance the familiar with the fresh ‚Äì use genre conventions creatively to meet audience expectations while delivering originality.",
        "Story is the chronological sequence of events; plot is how you arrange the sequence. Sometimes you start at the end, then the beginning, then the middle, etc.",
        "The Audience Will Forget Your Plot But Not Your Characters.",
        "Your character will lead you to your story and your plot.",
        "Voice creates character, character creates plot.",
        "Characters make things happen; things don't happen to them.",
        "You admire a character for trying more than for their successes.",
        "You gotta keep in mind what‚Äôs interesting to you as an audience, not what‚Äôs fun to do as a writer. They can be very different.",
        "Trying for theme is important, but you won‚Äôt see what the story is actually about till you‚Äôre at the end of it. Now rewrite.",
        "Once upon a time there was ___. Every day, ___. One day ___. Because of that, ___. Because of that, ___. Until finally ___.",
        "Simplify. Focus. Combine characters. Hop over detours. You‚Äôll feel like you‚Äôre losing valuable stuff but it sets you free.",
        "What is your character good at, comfortable with? Throw the polar opposite at them. Challenge them. How do they deal?",
        "Come up with your ending before you figure out your middle. Seriously. Endings are hard, get yours working up front.",
        "Finish your story, let go even if it‚Äôs not perfect. In an ideal world you have both, but move on. Do better next time.",
        "When you‚Äôre stuck, make a list of what WOULDN‚ÄôT happen next. Lots of times the material to get you unstuck will show up.",
        "Pull apart the stories you like. What you like in them is a part of you; you‚Äôve got to recognize it before you can use it.",
        "Putting it on paper lets you start fixing it. If it stays in your head‚Äîa perfect idea‚Äîyou‚Äôll never share it with anyone.",
        "Discount the 1st thing that comes to mind. And the 2nd, 3rd, 4th, 5th‚Äîget the obvious out of the way. Surprise yourself.",
        "Give your characters opinions. Passive/malleable might seem likable as you write, but it‚Äôs poison to the audience.",
        "Why must you tell THIS story? What‚Äôs the belief burning within you that your story feeds off of? That‚Äôs the heart of it.",
        "If you were your character in this situation, how would you feel? Honesty lends credibility to unbelievable situations.",
        "What are the stakes? Give us a reason to root for the character. What happens if they don‚Äôt succeed? Stack the odds against them.",
        "No work is ever wasted. If it‚Äôs not working, let go and move on‚Äîit‚Äôll come back around to be useful later.",
        "You have to know yourself: the difference between doing your best & fussing. Story is testing, not refining."
      ];

      function selectRating(cell) {
        const categoryIndex = Number(cell.getAttribute('data-category'));
        const rating = parseInt(cell.getAttribute('data-rating'));
        const row = cell.parentElement;
        row.querySelectorAll('td').forEach(td => {
          if (td !== row.firstElementChild) td.classList.remove('selected');
        });
        cell.classList.add('selected');
        scores[categoryIndex] = rating;
        updateTotal();
      }

      function updateTotal() {
        const total = Object.values(scores).reduce((a, b) => a + b, 0);
        document.getElementById('total').textContent = total;
        const ranking = document.getElementById('ranking');
        if (Object.keys(scores).length < 14) {
          ranking.textContent = 'Incomplete';
          ranking.style.color = '#64748b';
          updateProgressBar(total);
          return;
        }
        if (total < 29) {
          ranking.textContent = 'Needs Work üî¥';
          ranking.style.color = 'red';
        } else if (total < 42) {
          ranking.textContent = 'Good Start üü°';
          ranking.style.color = 'orange';
        } else if (total < 56) {
          ranking.textContent = 'Great! üü¢';
          ranking.style.color = 'green';
        } else {
          ranking.textContent = 'Perfect! üîµ';
          ranking.style.color = 'blue';
          if (typeof confetti === 'function') {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
          }
        }
        updateProgressBar(total);
      }

      function updateProgressBar(total) {
        const percentage = (total / 56) * 100;
        document.getElementById("progressBar").style.width = percentage + "%";
      }

      function autoResize(e) {
        const textarea = e.target;
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }

      async function exportPNG() {
        const tempContainer = document.createElement('div');
        // Place off-screen so it doesn't affect layout
        tempContainer.style.position = 'absolute';
        tempContainer.style.top = '-9999px';
        tempContainer.style.left = '-9999px';
        // Use computed style for background
        tempContainer.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-light');
        tempContainer.style.padding = "1rem";

        // Clone header and main content
        const headerClone = document.querySelector('header.analyzer-header').cloneNode(true);
        const mainClone = document.querySelector('main').cloneNode(true);
        tempContainer.appendChild(headerClone);
        tempContainer.appendChild(mainClone);
        document.body.appendChild(tempContainer);
        try {
          const canvas = await html2canvas(tempContainer, { scale: 2, useCORS: true });
          const dataUrl = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.download = 'storycraft-analysis.png';
          link.href = dataUrl;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (error) {
          console.error('PNG export failed:', error);
          alert('Error exporting PNG. Please try again.');
        }
        document.body.removeChild(tempContainer);
      }

      function resetScores() {
        scores = {};
        document.querySelectorAll('.selected').forEach(cell => cell.classList.remove('selected'));
        document.getElementById('quickSummary').value = '';
        document.getElementById('ranking').textContent = 'Incomplete';
        document.getElementById('ranking').style.color = '#64748b';
        document.getElementById('peerReviewList').innerHTML = '';
        document.getElementById('similarVideosList').innerHTML = '';
        peerReviews = [];
        document.getElementById('total').textContent = 0;
        document.getElementById('progressBar').style.width = '0%';
      }

      function toggleTheme(e) {
        if (e.target.checked) {
          document.documentElement.setAttribute("data-theme", "dark");
        } else {
          document.documentElement.removeAttribute("data-theme");
        }
      }

      function submitPeerReview() {
        const username = document.getElementById('peerReviewUsername').value.trim();
        const reviewInput = document.getElementById('peerReviewInput');
        const reviewText = reviewInput.value.trim();
        if (!username) {
          alert("Please enter your username for the peer review.");
          return;
        }
        if (!reviewText) return;
        peerReviews.push({ username: username, text: reviewText });
        updatePeerReviews();
        reviewInput.value = '';
      }
      
      function updatePeerReviews() {
        const peerReviewList = document.getElementById('peerReviewList');
        peerReviewList.innerHTML = peerReviews.map(rev =>
          `<li>${rev.username}: ${rev.text}</li>`
        ).join('');
      }
      
      function runAIReview() {
        const summary = document.getElementById('quickSummary').value.trim();
        const resultDiv = document.getElementById('aiReviewResult');
        if (!summary) {
          resultDiv.textContent = "Please enter a quick summary for AI review.";
          return;
        }
        
        const reviewIdeas = [
          {
            improvements: [
              "Clarify the central conflict by explicitly stating the stakes involved.",
              "Deepen your protagonist's motivation by highlighting internal dilemmas.",
              "Refine the narrative structure to better build suspense."
            ],
            suggestions: [
              "Revise the opening to immediately hook the viewer with a strong inciting incident.",
              "Emphasize a pivotal moment that clearly transitions the story toward its climax."
            ]
          },
          {
            improvements: [
              "Strengthen the emotional resonance by providing more backstory.",
              "Ensure that every plot twist reinforces the overall theme.",
              "Adjust the pacing to allow critical moments to breathe."
            ],
            suggestions: [
              "Introduce a memorable tagline that encapsulates your video's core message.",
              "Highlight a transformative moment that challenges the status quo."
            ]
          },
          {
            improvements: [
              "Focus on the uniqueness of your concept by underlining its innovative elements.",
              "Elaborate on the conflict to give viewers a clear sense of the story's stakes.",
              "Polish the narrative flow to create a more immersive experience."
            ],
            suggestions: [
              "Rework the summary‚Äôs introduction to better reflect your video's distinct style.",
              "Include a succinct conclusion that leaves the audience with a lingering thought."
            ]
          }
        ];
        
        const randomIndex = Math.floor(Math.random() * reviewIdeas.length);
        const reviewSet = reviewIdeas[randomIndex];
        
        const summaryWords = summary.split(" ");
        const summaryPreview = summaryWords.slice(0, 10).join(" ") + (summaryWords.length > 10 ? "..." : "");
        
        let reviewHTML = "<h3>ü§ñ AI Story Review</h3>";
        reviewHTML += `<p>Based on your concept: "<em>${summaryPreview}</em>", consider the following ideas:</p>`;
        reviewHTML += "<h4>Three Specific Improvements:</h4>";
        reviewHTML += "<ol>";
        reviewSet.improvements.forEach(item => {
          reviewHTML += `<li>${item}</li>`;
        });
        reviewHTML += "</ol>";
        reviewHTML += "<h4>Two Actionable Suggestions:</h4>";
        reviewHTML += "<ol>";
        reviewSet.suggestions.forEach(item => {
          reviewHTML += `<li>${item}</li>`;
        });
        reviewHTML += "</ol>";
        
        resultDiv.innerHTML = reviewHTML;
      }
    </script>
  </body>
</html>
