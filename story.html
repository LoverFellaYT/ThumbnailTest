<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StoryCraft Analyzer Pro+ Enhanced</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnH/PRRZ9i6Lkxy/lK+Ad+Qw3PweIIsXgTn5N2sA3ZgP6L6YKn42pPZLNSQNkI3b7HlFj5pAg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Google Font: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS Styles -->
    <style>
      /* --------------------------------------------------------------
         CSS Variables & Base Styles
         -------------------------------------------------------------- */
      :root {
        --primary-light: #4facfe;
        --accent-light: #00f2fe;
        --bg-light: #f9fafb;
        --text-light: #1e293b;
        --panel-light: rgba(255, 255, 255, 0.96);
        --border-light: rgba(255, 255, 255, 0.2);
        --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        --transition: all 0.2s ease;
        --radius: 14px;
        --gradient-light: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%);
        --spacing: 1rem;
        --font-base: 'Roboto', sans-serif;
        --table-cell-bg-light: rgba(255, 255, 255, 0.85);
      }
      html[data-theme="dark"] {
        --bg-light: #1f1f1f;
        --text-light: #f3f3f3;
        --panel-light: rgba(18, 18, 18, 0.98);
        --border-light: rgba(255, 255, 255, 0.2);
        --gradient-light: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --table-cell-bg-light: rgba(30, 30, 30, 0.85);
      }
      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-base);
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px), var(--bg-light);
        background-size: 30px 30px;
        color: var(--text-light);
        transition: var(--transition);
      }

      /* Container for entire page content */
      .analyzer-container {
        width: 98%;
        max-width: 1100px;
        margin: 2rem auto;
        padding: 0 var(--spacing) 2rem;
        text-align: center;
      }

      /* --------------------------------------------------------------
         Header / Sticky Banner
         -------------------------------------------------------------- */
      header.analyzer-header {
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: 1.5rem 2rem;
        margin-bottom: var(--spacing);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--panel-light);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        animation: headerGlow 3s infinite alternate;
      }
      @keyframes headerGlow {
        from { box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        to { box-shadow: 0 0 30px rgba(255,215,0,1); }
      }
      .header-left {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .header-left h1 {
        font-size: 2rem;
        margin: 0;
        font-weight: bold;
      }

      /* Score & Progress Bar inside the header */
      .score-info {
        margin-top: 0.5rem;
      }
      .score-info p {
        margin: 0.2rem 0;
        font-size: 0.9rem;
      }
      .progress-container {
        width: 200px;
        height: 10px;
        background: #ccc;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 0.3rem;
      }
      #progressBar {
        height: 10px;
        background: #4facfe;
        width: 0%;
        transition: width 0.3s;
      }

      .header-right {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }

      /* --------------------------------------------------------------
         Button Styling
         -------------------------------------------------------------- */
      button.btn {
        background: var(--gradient-light);
        color: #fff;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px rgba(126, 34, 206, 0.2);
      }
      button.btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(126, 34, 206, 0.4);
      }
      /* Rainbow Button as a Rainbow Emoji */
      button.rainbow-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
      }
      button.rainbow-btn:hover {
        transform: scale(1.2);
      }

      /* --------------------------------------------------------------
         Dark Mode Toggle Styles
         -------------------------------------------------------------- */
      .dark-mode {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
      }
      .toggle-label {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
      }
      .dark-mode-slider {
        position: relative;
        width: 60px;
        height: 30px;
        background-color: #e0e0e0;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 5px;
        transition: background-color 0.3s;
      }
      .dark-mode-slider .mode-label {
        font-size: 16px;
        user-select: none;
      }
      .dark-mode-slider .slider-thumb {
        position: absolute;
        width: 26px;
        height: 26px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }
      input#darkModeToggle {
        display: none;
      }
      input#darkModeToggle:checked + .dark-mode-slider .slider-thumb {
        transform: translateX(30px);
      }
      input#darkModeToggle:checked + .dark-mode-slider {
        background-color: var(--primary-light);
      }

      /* --------------------------------------------------------------
         Glass Panels for Sections
         -------------------------------------------------------------- */
      .glass-panel {
        background: var(--panel-light);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        padding: 2rem;
        margin: 1rem 0;
        text-align: center;
      }
      .glass-panel h2 {
        margin-top: 0;
        text-align: center;
      }

      /* --------------------------------------------------------------
         Input Areas & Textarea Styling
         -------------------------------------------------------------- */
      .input-section {
        margin: 1rem 0;
      }
      .story-input {
        width: 100%;
        min-height: 120px;
        padding: 1rem;
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
        font-size: 1rem;
        background: var(--bg-light);
        resize: none;
        transition: var(--transition);
        margin-bottom: 0.5rem;
      }
      .story-input:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
      }
      input[type="text"] {
        padding: 0.5rem;
        width: 70%;
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
      }

      /* --------------------------------------------------------------
         Similar Videos Section
         -------------------------------------------------------------- */
      .similar-videos-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
      }
      .video-thumbnail {
        width: 200px;
        overflow: hidden;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
      }
      .video-thumbnail img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
      }
      .video-title {
        padding: 0.5rem;
        font-size: 0.9rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0 4px;
        line-height: 1;
      }
      .video-thumbnail:hover {
        transform: scale(1.02);
      }

      /* --------------------------------------------------------------
         Rubric Table Styling
         -------------------------------------------------------------- */
      .rubric-table {
        margin: 1rem 0;
      }
      .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
      }
      .modern-table th {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        text-align: left;
        position: sticky;
        top: 0;
        backdrop-filter: blur(10px);
        z-index: 10;
        background: var(--gradient-light);
        color: #fff;
      }
      .modern-table th:nth-child(2) { background: #f87171; color: #fff; }
      .modern-table th:nth-child(3) { background: #fb923c; color: #fff; }
      .modern-table th:nth-child(4) { background: #facc15; color: #000; }
      .modern-table th:nth-child(5) { background: #4ade80; color: #fff; }
      .modern-table td {
        padding: 0.75rem 1.5rem;
        background: var(--table-cell-bg-light);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        transition: var(--transition);
        vertical-align: top;
      }
      .modern-table td:hover:not(.category-header) {
        background: rgba(224, 231, 255, 0.3);
      }
      .modern-table td.selected {
        background: rgba(224, 231, 255, 0.5) !important;
        border-left: 4px solid var(--primary-light);
      }
      .category-header {
        font-weight: 600;
        background: rgba(79, 172, 254, 0.03);
        position: sticky;
        left: 0;
        min-width: 180px;
      }

      /* --------------------------------------------------------------
         Self-Assessment Checklist Styling
         -------------------------------------------------------------- */
      #selfAssessmentSection ul {
        list-style-type: none;
        padding: 0;
        margin: 0 auto;
        max-width: 600px;
        text-align: left;
      }
      #selfAssessmentSection li {
        margin-bottom: 0.5rem;
      }
      #selfAssessmentSection li label {
        cursor: pointer;
      }

      /* Rain animation overlay (NEW) */
      .rain-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        pointer-events: none;
        overflow: hidden;
        z-index: 9999; /* Appear above everything else */
      }
      .raindrop {
        position: absolute;
        top: -10px;
        width: 2px;
        height: 14px;
        background: #4499ff;
        border-radius: 1px;
        opacity: 0.8;
        animation-name: raindrop;
        animation-timing-function: linear;
        animation-iteration-count: 1;
      }
      @keyframes raindrop {
        0% {
          transform: translateY(0px) scaleY(1);
          opacity: 1;
        }
        100% {
          transform: translateY(120vh) scaleY(0.2);
          opacity: 0;
        }
      }

      @media (max-width: 768px) {
        header.analyzer-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .header-right {
          margin-top: 1rem;
          width: 100%;
          justify-content: space-around;
        }
        .score-info {
          margin-top: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- HEADER / Sticky Banner -->
    <header class="analyzer-header">
      <div class="header-left">
        <h1>StoryCraft Analyzer</h1>
        <div class="score-info">
          <p>
            Total Score: <span id="total">0</span> / 56
          </p>
          <p>
            Ranking: <span id="ranking">Incomplete</span>
          </p>
          <div class="progress-container">
            <div id="progressBar"></div>
          </div>
        </div>
      </div>

      <div class="header-right">
        <button class="btn" id="resetBtn">üîÑ Reset</button>
        <button class="btn" id="exportBtn">üñºÔ∏è Export PNG</button>
        <button class="btn" id="rainbowBtn">üåà</button>
        <div class="dark-mode">
          <label class="toggle-label" for="darkModeToggle">
            <input type="checkbox" id="darkModeToggle" aria-label="Toggle Dark Mode" />
            <div class="dark-mode-slider">
              <span class="mode-label">‚òÄÔ∏è</span>
              <span class="mode-label">üåô</span>
              <div class="slider-thumb"></div>
            </div>
          </label>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main>
      <div class="analyzer-container">
        <!-- Quick Summary Section -->
        <div class="glass-panel input-section" id="quickSummarySection">
          <h2>üìù Quick Summary</h2>
          <textarea id="quickSummary" class="story-input" placeholder="Summarize the story or video in a few lines..."></textarea>
        </div>

        <!-- Similar Videos Section -->
        <div class="glass-panel input-section" id="similarVideosSection">
          <h2>üì∫ Similar Videos</h2>
          <input type="text" id="youtubeLinkInput" placeholder="Enter YouTube video URL..." />
          <button class="btn" id="addVideoBtn">Add Video</button>
          <div id="similarVideosList" class="similar-videos-list"></div>
        </div>

        <!-- AI Review Section -->
        <div class="glass-panel input-section" id="aiReviewSection">
          <h2>ü§ñ AI Review</h2>
          <button class="btn" id="runAIReviewBtn">Run AI Review</button>
          <div id="aiReviewResult" style="margin-top: 1rem;"></div>
        </div>

        <!-- Rubric Table Section -->
        <div class="glass-panel rubric-table" id="rubricSection">
          <h2>üìä Rubric Table</h2>
          <table class="modern-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Good (1)</th>
                <th>Great (2)</th>
                <th>Excellent (3)</th>
                <th>Outstanding (4)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="category-header" data-category="0" title="The opener should immediately grab attention.">Hook &amp; Opening</td>
                <td data-category="0" data-rating="1">Slow start; no hook</td>
                <td data-category="0" data-rating="2">Basic hook</td>
                <td data-category="0" data-rating="3">Intriguing hook</td>
                <td data-category="0" data-rating="4">Unignorable opener</td>
              </tr>
              <tr>
                <td class="category-header" data-category="1" title="A clear goal keeps the narrative focused.">Clarity of Goal</td>
                <td data-category="1" data-rating="1">No clear purpose</td>
                <td data-category="1" data-rating="2">Goal exists but gets lost</td>
                <td data-category="1" data-rating="3">Clear goal w/ minor tangents</td>
                <td data-category="1" data-rating="4">Crystal‚Äëclear premise</td>
              </tr>
              <tr>
                <td class="category-header" data-category="2" title="Maintaining audience engagement is key.">Audience Retention</td>
                <td data-category="2" data-rating="1">Drags/loses viewers quickly</td>
                <td data-category="2" data-rating="2">A few engaging moments</td>
                <td data-category="2" data-rating="3">Strong pacing &amp; reveals</td>
                <td data-category="2" data-rating="4">Masterful tension arcs</td>
              </tr>
              <tr>
                <td class="category-header" data-category="3" title="The story should feel genuine and relatable.">Authenticity &amp; Relatability</td>
                <td data-category="3" data-rating="1">Feels forced; no connection</td>
                <td data-category="3" data-rating="2">Some genuine moments</td>
                <td data-category="3" data-rating="3">Relatable &amp; sincere</td>
                <td data-category="3" data-rating="4">Deeply authentic</td>
              </tr>
              <tr>
                <td class="category-header" data-category="4" title="A strong emotional arc leaves a lasting impact.">Emotional Arc &amp; Payoff</td>
                <td data-category="4" data-rating="1">Flat; no highs/lows</td>
                <td data-category="4" data-rating="2">Moments of excitement</td>
                <td data-category="4" data-rating="3">Clear emotional journey</td>
                <td data-category="4" data-rating="4">Masterpiece arcs</td>
              </tr>
              <tr>
                <td class="category-header" data-category="5" title="Conflict should raise the stakes.">Conflict &amp; Stakes</td>
                <td data-category="5" data-rating="1">Low urgency</td>
                <td data-category="5" data-rating="2">Basic stakes</td>
                <td data-category="5" data-rating="3">High stakes/punishments</td>
                <td data-category="5" data-rating="4">Unavoidable drama</td>
              </tr>
              <tr>
                <td class="category-header" data-category="6" title="Calls to action guide the audience.">CTA &amp; Audience Interaction</td>
                <td data-category="6" data-rating="1">No or weak CTA</td>
                <td data-category="6" data-rating="2">Generic "like/subscribe"</td>
                <td data-category="6" data-rating="3">Clear creative CTA</td>
                <td data-category="6" data-rating="4">Actionable &amp; emotional CTA</td>
              </tr>
              <tr>
                <td class="category-header" data-category="7" title="A fresh angle differentiates your story.">Originality &amp; Trend‚ÄëJacking</td>
                <td data-category="7" data-rating="1">Clich√© concept</td>
                <td data-category="7" data-rating="2">Minor twist on trends</td>
                <td data-category="7" data-rating="3">Fresh angle</td>
                <td data-category="7" data-rating="4">Boundary‚Äëpushing</td>
              </tr>
              <tr>
                <td class="category-header" data-category="8" title="Memorable content is highly shareable.">Replayability &amp; Shareability</td>
                <td data-category="8" data-rating="1">Forgettable</td>
                <td data-category="8" data-rating="2">Some memeable moments</td>
                <td data-category="8" data-rating="3">Highly shareable</td>
                <td data-category="8" data-rating="4">Clip‚Äëworthy highlights</td>
              </tr>
              <tr>
                <td class="category-header" data-category="9" title="Brand consistency reinforces identity.">Branding Consistency</td>
                <td data-category="9" data-rating="1">No branding</td>
                <td data-category="9" data-rating="2">Basic branding</td>
                <td data-category="9" data-rating="3">Consistent style</td>
                <td data-category="9" data-rating="4">Iconic brand identity</td>
              </tr>
              <tr>
                <td class="category-header" data-category="10" title="Well‚Äëdeveloped characters add depth.">Character Development</td>
                <td data-category="10" data-rating="1">Flat, one‚Äëdimensional characters</td>
                <td data-category="10" data-rating="2">Some traits are evident</td>
                <td data-category="10" data-rating="3">Well‚Äëdeveloped with clear motivations</td>
                <td data-category="10" data-rating="4">Rich, evolving characters that captivate</td>
              </tr>
              <tr>
                <td class="category-header" data-category="11" title="Authentic dialogue enhances realism.">Dialogue Authenticity</td>
                <td data-category="11" data-rating="1">Unnatural, stilted dialogue</td>
                <td data-category="11" data-rating="2">Some lines feel genuine</td>
                <td data-category="11" data-rating="3">Dialogue flows naturally</td>
                <td data-category="11" data-rating="4">Exceptional dialogue with distinct voice</td>
              </tr>
              <tr>
                <td class="category-header" data-category="12" title="A vivid setting brings the world to life.">World‚ÄëBuilding</td>
                <td data-category="12" data-rating="1">Vague setting with little detail</td>
                <td data-category="12" data-rating="2">Some descriptive elements</td>
                <td data-category="12" data-rating="3">Engaging and immersive world‚Äëbuilding</td>
                <td data-category="12" data-rating="4">Exceptionally vivid, intricate details</td>
              </tr>
              <tr>
                <td class="category-header" data-category="13" title="Balanced pacing keeps the reader hooked.">Pacing &amp; Rhythm</td>
                <td data-category="13" data-rating="1">Story drags; uneven pace</td>
                <td data-category="13" data-rating="2">Some parts drag‚Äîreview transitions</td>
                <td data-category="13" data-rating="3">Generally well‚Äëpaced</td>
                <td data-category="13" data-rating="4">Flawless pacing that maintains tension</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Human Feedback Section -->
        <div class="glass-panel input-section" id="humanFeedbackSection">
          <h2>üë• Human Feedback</h2>
          <textarea id="humanFeedback" class="story-input" placeholder="Add your own notes and feedback here..." style="min-height: 100px;"></textarea>
        </div>

        <!-- Self-Assessment Checklist Section -->
        <div class="glass-panel input-section" id="selfAssessmentSection">
          <h2>‚úÖ Self-Assessment Checklist</h2>
          <ul>
            <li>
              <input type="checkbox" id="check1" />
              <label for="check1"><strong>Hook:</strong> Does the opening grab attention in the first few seconds?</label>
            </li>
            <li>
              <input type="checkbox" id="check2" />
              <label for="check2"><strong>Goal:</strong> Is the main objective/challenge clearly defined?</label>
            </li>
            <li>
              <input type="checkbox" id="check3" />
              <label for="check3"><strong>Conflict &amp; Stakes:</strong> Are obstacles and stakes high enough to keep viewers invested?</label>
            </li>
            <li>
              <input type="checkbox" id="check4" />
              <label for="check4"><strong>Structure:</strong> Does the story flow logically from setup to escalation to resolution?</label>
            </li>
            <li>
              <input type="checkbox" id="check5" />
              <label for="check5"><strong>Audience Retention Hooks:</strong> Have you planned moments or reveals that keep viewers from clicking away?</label>
            </li>
            <li>
              <input type="checkbox" id="check6" />
              <label for="check6"><strong>Credibility &amp; Believability:</strong> Do plot points and scenarios feel authentic, not forced?</label>
            </li>
            <li>
              <input type="checkbox" id="check7" />
              <label for="check7"><strong>CTA or Interaction Point:</strong> Is there a clear moment where you invite audience participation (like, comment, etc.)?</label>
            </li>
            <li>
              <input type="checkbox" id="check8" />
              <label for="check8"><strong>Uniqueness:</strong> Do you offer something fresh or tap into current trends in a new way?</label>
            </li>
            <li>
              <input type="checkbox" id="check9" />
              <label for="check9"><strong>Pacing:</strong> Does each scene/segment have a strong reason to exist without dragging?</label>
            </li>
            <li>
              <input type="checkbox" id="check10" />
              <label for="check10"><strong>Shareability:</strong> Is there a ‚Äúwow‚Äù factor or memorable highlight that encourages sharing?</label>
            </li>
          </ul>
        </div>
      </div>
    </main>

    <!-- JavaScript -->
    <script>
      // Global variables
      let scores = {};

      window.addEventListener('DOMContentLoaded', () => {
        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('change', toggleTheme);
        // Export PNG button
        document.getElementById('exportBtn').addEventListener('click', exportPNG);
        // Rainbow quote button
        document.getElementById('rainbowBtn').addEventListener('click', showRainbowQuote);
        // AI Review button
        document.getElementById('runAIReviewBtn')?.addEventListener('click', runAIReview);
        // Add YouTube video button
        document.getElementById('addVideoBtn').addEventListener('click', addYouTubeVideo);
        // Rubric cell click
        document.querySelectorAll('.modern-table td[data-rating]').forEach(cell => {
          cell.addEventListener('click', () => selectRating(cell));
        });
        // Auto-resize textareas
        document.querySelectorAll('.story-input').forEach(textarea => {
          textarea.addEventListener('input', autoResize);
        });
        // Reset button
        document.getElementById('resetBtn').addEventListener('click', resetScores);
      });

      /* RAIN ANIMATION - Called when reset is clicked */
      function runRainAnimation() {
        // Create container for raindrops
        const rainContainer = document.createElement('div');
        rainContainer.classList.add('rain-container');
        document.body.appendChild(rainContainer);

        // Generate raindrops
        const dropCount = 50; // number of raindrops
        for (let i = 0; i < dropCount; i++) {
          const drop = document.createElement('div');
          drop.classList.add('raindrop');
          // random horizontal position
          drop.style.left = Math.random() * 100 + 'vw';
          // random animation duration & delay
          drop.style.animationDuration = (Math.random() * 1.5 + 1) + 's';
          drop.style.animationDelay = Math.random() * 1 + 's';
          rainContainer.appendChild(drop);
        }

        // Remove rain overlay after 3 seconds
        setTimeout(() => {
          rainContainer.remove();
        }, 3000);
      }

      function showRainbowQuote() {
        const quotes = [
          "The test of good writing and good story is: does it not only reward the first viewing, but also the second viewing?",
          "Movies are all about the last ten minutes\nTools, not rules",
          "When the climax is established, work backwards and ask \"if this scene was removed, would the climax still work? If it would still work, remove that scene\"",
          // ... More quotes from your list ...
          "You gotta identify with your situation/characters; you can‚Äôt just write ‚Äòcool‚Äô. What would make YOU act that way?",
          "What‚Äôs the essence of your story? The most economical telling of it? If you know that, you can build out from there."
        ];
        const randomIndex = Math.floor(Math.random() * quotes.length);
        alert(quotes[randomIndex]);
      }

      function selectRating(cell) {
        const categoryIndex = Number(cell.getAttribute('data-category'));
        const rating = parseInt(cell.getAttribute('data-rating'));
        const row = cell.parentElement;
        row.querySelectorAll('td').forEach(td => {
          if (td !== row.firstElementChild) td.classList.remove('selected');
        });
        cell.classList.add('selected');
        scores[categoryIndex] = rating;
        updateTotal();
      }

      function updateTotal() {
        const total = Object.values(scores).reduce((a, b) => a + b, 0);
        document.getElementById('total').textContent = total;
        const ranking = document.getElementById('ranking');
        if (Object.keys(scores).length < 14) {
          ranking.textContent = 'Incomplete';
          ranking.style.color = '#64748b';
          updateProgressBar(total);
          return;
        }
        if (total < 29) {
          ranking.textContent = 'Needs Work üî¥';
          ranking.style.color = 'red';
        } else if (total < 42) {
          ranking.textContent = 'Good Start üü°';
          ranking.style.color = 'orange';
        } else if (total < 56) {
          ranking.textContent = 'Great! üü¢';
          ranking.style.color = 'green';
        } else {
          ranking.textContent = 'Perfect! üîµ';
          ranking.style.color = 'blue';
          if (typeof confetti === 'function') {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
          }
        }
        updateProgressBar(total);
      }

      function updateProgressBar(total) {
        const percentage = (total / 56) * 100;
        document.getElementById("progressBar").style.width = percentage + "%";
      }

      function autoResize(e) {
        const textarea = e.target;
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }

      async function exportPNG() {
        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'absolute';
        tempContainer.style.top = '-9999px';
        tempContainer.style.left = '-9999px';
        tempContainer.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-light');
        tempContainer.style.padding = "1rem";

        const headerClone = document.querySelector('header.analyzer-header').cloneNode(true);
        const mainClone = document.querySelector('main').cloneNode(true);

        tempContainer.appendChild(headerClone);
        tempContainer.appendChild(mainClone);
        document.body.appendChild(tempContainer);
        try {
          const canvas = await html2canvas(tempContainer, { scale: 2, useCORS: true });
          const dataUrl = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.download = 'storycraft-analysis.png';
          link.href = dataUrl;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (error) {
          console.error('PNG export failed:', error);
          alert('Error exporting PNG. Please try again.');
        }
        document.body.removeChild(tempContainer);
      }

      function resetScores() {
        scores = {};
        document.querySelectorAll('.selected').forEach(cell => cell.classList.remove('selected'));
        document.getElementById('quickSummary').value = '';
        document.getElementById('humanFeedback').value = '';
        document.getElementById('ranking').textContent = 'Incomplete';
        document.getElementById('ranking').style.color = '#64748b';
        document.getElementById('similarVideosList').innerHTML = '';
        document.getElementById('total').textContent = 0;
        document.getElementById('progressBar').style.width = '0%';

        // *** Trigger the new rain animation here ***
        runRainAnimation();
      }

      function toggleTheme(e) {
        if (e.target.checked) {
          document.documentElement.setAttribute("data-theme", "dark");
        } else {
          document.documentElement.removeAttribute("data-theme");
        }
      }

      function runAIReview() {
        const summary = document.getElementById('quickSummary').value.trim();
        const resultDiv = document.getElementById('aiReviewResult');
        if (!summary) {
          resultDiv.textContent = "Please enter a quick summary for AI review.";
          return;
        }
        const reviewIdeas = [
          {
            improvements: [
              "Clarify the central conflict by explicitly stating the stakes involved.",
              "Deepen your protagonist's motivation by highlighting internal dilemmas.",
              "Refine the narrative structure to better build suspense."
            ],
            suggestions: [
              "Revise the opening to immediately hook the viewer with a strong inciting incident.",
              "Emphasize a pivotal moment that clearly transitions the story toward its climax."
            ]
          },
          {
            improvements: [
              "Strengthen the emotional resonance by providing more backstory.",
              "Ensure that every plot twist reinforces the overall theme.",
              "Adjust the pacing to allow critical moments to breathe."
            ],
            suggestions: [
              "Introduce a memorable tagline that encapsulates your video's core message.",
              "Highlight a transformative moment that challenges the status quo."
            ]
          },
          {
            improvements: [
              "Focus on the uniqueness of your concept by underlining its innovative elements.",
              "Elaborate on the conflict to give viewers a clear sense of the story's stakes.",
              "Polish the narrative flow to create a more immersive experience."
            ],
            suggestions: [
              "Rework the summary‚Äôs introduction to better reflect your video's distinct style.",
              "Include a succinct conclusion that leaves the audience with a lingering thought."
            ]
          }
        ];
        const randomIndex = Math.floor(Math.random() * reviewIdeas.length);
        const reviewSet = reviewIdeas[randomIndex];
        const summaryWords = summary.split(" ");
        const summaryPreview =
          summaryWords.slice(0, 10).join(" ") + (summaryWords.length > 10 ? "..." : "");

        let reviewHTML = "<h3>ü§ñ AI Story Review</h3>";
        reviewHTML += `<p>Based on your concept: "<em>${summaryPreview}</em>", consider the following ideas:</p>`;
        reviewHTML += "<h4>Three Specific Improvements:</h4>";
        reviewHTML += "<ol>";
        reviewSet.improvements.forEach(item => {
          reviewHTML += `<li>${item}</li>`;
        });
        reviewHTML += "</ol>";
        reviewHTML += "<h4>Two Actionable Suggestions:</h4>";
        reviewHTML += "<ol>";
        reviewSet.suggestions.forEach(item => {
          reviewHTML += `<li>${item}</li>`;
        });
        reviewHTML += "</ol>";
        resultDiv.innerHTML = reviewHTML;
      }
    </script>
  </body>
</html>
