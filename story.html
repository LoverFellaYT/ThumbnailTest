<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StoryCraft Analyzer - Plan Viral Videos</title>
    <meta name="description" content="Review and enhance your YouTube and Roblox video concepts before recording with StoryCraft Analyzer!" />
    <meta name="keywords" content="StoryCraft, YouTube, Roblox, video planning, story analyzer" />
    <meta name="author" content="loverfellayt" />
    <link rel="icon" href="https://via.placeholder.com/32" type="image/x-icon" />

    <!-- External Libraries -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnH/PRRZ9i6Lkxy/lK+Ad+Qw3PweIIsXgTn5N2sA3ZgP6L6YKn42pPZLNSQNkI3b7HlFj5pAg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

    <!-- CSS Styles -->
    <style>
      :root {
        --primary-light: #4facfe;
        --accent-light: #00f2fe;
        --bg-light: #f9fafb;
        --text-light: #1e293b;
        --panel-light: rgba(255, 255, 255, 0.96);
        --border-light: rgba(255, 255, 255, 0.2);
        --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        --transition: all 0.2s ease;
        --radius: 16px;
        --gradient-light: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%);
        --spacing: 1.5rem;
        --font-base: 'Poppins', sans-serif;
        --highlight: #ff6b6b;
      }
      html[data-theme="dark"] {
        --bg-light: #1f1f1f;
        --text-light: #f3f3f3;
        --panel-light: rgba(18, 18, 18, 0.98);
        --border-light: rgba(255, 255, 255, 0.2);
        --gradient-light: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }

      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-base);
        background: var(--bg-light);
        color: var(--text-light);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        position: relative;
      }

      .hero {
        text-align: center;
        padding: 3rem 1rem;
        background: var(--gradient-light);
        color: #fff;
        border-radius: 0 0 var(--radius) var(--radius);
        box-shadow: var(--shadow);
      }
      .hero h1 {
        font-size: clamp(2rem, 5vw, 2.8rem);
        margin: 0;
        font-weight: 700;
      }
      .hero p {
        font-size: clamp(1rem, 3vw, 1.3rem);
        margin: 0.5rem 0 1rem;
      }

      #darkModeToggle {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
      }

      #progress {
        position: relative;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 1rem 0;
        text-align: center;
      }
      #progressBar {
        height: 100%;
        width: 0%;
        background: var(--gradient-light);
        transition: width 0.3s ease;
      }
      #progressText {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.9rem;
        color: var(--text-light);
      }

      nav {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 1rem;
        margin: var(--spacing) 0;
      }
      nav button {
        background: var(--panel-light);
        border: 2px solid var(--border-light);
        padding: 0.8rem 1.5rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        transform: scale(1);
        transition: transform 0.2s, background 0.2s;
      }
      nav button.active, nav button:hover {
        background: var(--gradient-light);
        color: #fff;
        transform: scale(1.05);
      }

      .tab {
        display: none;
      }
      .tab.active {
        display: block;
      }

      .glass-panel {
        background: var(--panel-light);
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        padding: 2rem;
        margin: var(--spacing) 0;
      }
      .glass-panel h2, .glass-panel h3 {
        color: var(--highlight);
        font-size: clamp(1.4rem, 4vw, 1.8rem);
        margin-top: 0;
      }

      .story-input {
        width: 100%;
        min-height: 150px;
        padding: 1rem;
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
        font-size: 1rem;
        background: var(--bg-light);
        resize: vertical;
        transition: var(--transition);
        color: var(--text-light);
      }
      html[data-theme="dark"] .story-input {
        color: #fff;
      }
      .story-input:focus {
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        outline: none;
      }

      .rubric-table {
        width: 100%;
        overflow-x: auto;
      }
      .modern-table {
        width: 100%;
        min-width: clamp(600px, 100vw, 900px);
        border-collapse: separate;
        border-spacing: 0;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      .modern-table th, .modern-table td {
        padding: 1rem 1.5rem;
        font-size: 0.9rem;
      }
      .modern-table th {
        background: var(--gradient-light);
        color: #fff;
      }
      .modern-table th:nth-child(2) { background: #f87171; }
      .modern-table th:nth-child(3) { background: #fb923c; }
      .modern-table th:nth-child(4) { background: #facc15; color: #000; }
      .modern-table th:nth-child(5) { background: #4ade80; }
      .modern-table td[data-rating] {
        cursor: pointer;
        transition: background 0.2s;
      }
      .modern-table td[data-rating]:hover, .modern-table td[data-rating]:focus {
        background: rgba(79, 172, 254, 0.2);
      }
      .modern-table td.selected {
        background: rgba(224, 231, 255, 0.5);
        border-left: 4px solid var(--primary-light);
        animation: pulse 0.3s ease;
      }
      .weight {
        width: 50px;
        margin-left: 0.5rem;
        padding: 0.2rem;
        border-radius: 4px;
      }
      .tooltip {
        position: relative;
        display: inline-block;
      }
      .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background: var(--panel-light);
        color: var(--text-light);
        text-align: center;
        border-radius: 6px;
        padding: 0.5rem;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s;
      }
      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }
      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

      #feedbackOutput, #plannerList {
        text-align: left;
        margin-top: 1rem;
      }
      #feedbackOutput ul, #plannerList ul {
        list-style-type: disc;
        padding-left: 2rem;
      }
      #prompts {
        display: none;
        text-align: left;
        margin-top: 1rem;
      }

      .timeline-block {
        display: inline-block;
        padding: 1rem;
        border: 1px solid var(--border-light);
        margin: 0.5rem;
        border-radius: 8px;
        background: var(--bg-light);
      }
      .timeline-block input {
        width: 200px;
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: var(--text-light);
      }

      button.btn {
        background: var(--gradient-light);
        color: #fff;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        margin: 0.5rem;
      }
      button.btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(126, 34, 206, 0.4);
      }

      footer {
        text-align: center;
        padding: var(--spacing);
        font-size: 0.9rem;
        color: #64748b;
      }
      footer a {
        color: var(--primary-light);
        text-decoration: none;
      }
      footer a:hover {
        text-decoration: underline;
      }

      #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary-light);
        color: #fff;
        padding: 1rem;
        border-radius: 8px;
        display: none;
        z-index: 1000;
        white-space: pre-wrap;
      }

      @media (max-width: 768px) {
        .modern-table th, .modern-table td {
          padding: 0.8rem;
          font-size: 0.85rem;
        }
        nav { flex-direction: column; align-items: center; }
        .timeline-block { display: block; width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Hero Section -->
      <section class="hero">
        <h1>StoryCraft Analyzer</h1>
        <p>Plan and enhance your YouTube & Roblox video concepts before recording!</p>
      </section>

      <!-- Dark Mode Toggle -->
      <button id="darkModeToggle">🌙</button>

      <!-- Progress Tracker -->
      <div id="progress">
        <div id="progressBar"></div>
        <span id="progressText">0/4</span>
      </div>

      <!-- Workflow Tabs -->
      <nav>
        <button id="tab-concept" class="active" onclick="showTab('concept')">1. Concept</button>
        <button id="tab-score" onclick="showTab('score')">2. Score</button>
        <button id="tab-feedback" onclick="showTab('feedback')">3. Feedback</button>
        <button id="tab-plan" onclick="showTab('plan')">4. Plan</button>
      </nav>

      <!-- Main Content -->
      <main>
        <!-- Concept Input -->
        <section id="concept" class="tab glass-panel active">
          <h2>📝 Video Concept</h2>
          <select id="examples">
            <option value="">Pick an example</option>
            <option value="I prank 100 Roblox players with a fake update and chaos ensues.">Roblox Prank</option>
            <option value="I race to hatch a legendary pet in Pet Simulator 99 before the server crashes.">Pet Sim Challenge</option>
            <option value="I turn Restaurant Tycoon into a haunted diner for 24 hours.">Haunted Tycoon</option>
          </select>
          <select id="templates"><option value="">Load a template</option></select>
          <button class="btn" onclick="saveTemplate()">Save Template</button>
          <textarea id="quickSummary" class="story-input" placeholder="Include your hook, conflict, and goal (e.g., 'I hatch 1000 eggs in Pet Simulator 99 to find a legendary pet, racing against a server crash')"></textarea>
          <p>Word count: <span id="wordCount">0</span></p>
          <button class="btn" onclick="showTab('score')">Next: Score Your Idea</button>
        </section>

        <!-- Scoring -->
        <section id="score" class="tab glass-panel">
          <h2>📊 Score Your Idea</h2>
          <div class="rubric-table">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>Category (Weight)</th>
                  <th>Good (1)</th>
                  <th>Great (2)</th>
                  <th>Excellent (3)</th>
                  <th>Outstanding (4)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="tooltip">🎣 Hook <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="0"><span class="tooltiptext">First 10 seconds to grab attention</span></td>
                  <td data-category="0" data-rating="1" tabindex="0" role="button" aria-label="Rate Hook as Good">Slow or unclear start</td>
                  <td data-category="0" data-rating="2" tabindex="0" role="button" aria-label="Rate Hook as Great">Basic hook, mildly curious</td>
                  <td data-category="0" data-rating="3" tabindex="0" role="button" aria-label="Rate Hook as Excellent">Intriguing opener draws interest</td>
                  <td data-category="0" data-rating="4" tabindex="0" role="button" aria-label="Rate Hook as Outstanding">Unignorable, instant grab</td>
                </tr>
                <tr>
                  <td class="tooltip">🎯 Goal <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="1"><span class="tooltiptext">What’s the video aiming to achieve?</span></td>
                  <td data-category="1" data-rating="1" tabindex="0" role="button" aria-label="Rate Goal as Good">Vague or hidden purpose</td>
                  <td data-category="1" data-rating="2" tabindex="0" role="button" aria-label="Rate Goal as Great">Goal present but unclear</td>
                  <td data-category="1" data-rating="3" tabindex="0" role="button" aria-label="Rate Goal as Excellent">Well-defined objective</td>
                  <td data-category="1" data-rating="4" tabindex="0" role="button" aria-label="Rate Goal as Outstanding">Crystal-clear, high-stakes aim</td>
                </tr>
                <tr>
                  <td class="tooltip">⚔️ Conflict <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="2"><span class="tooltiptext">Main obstacle driving tension</span></td>
                  <td data-category="2" data-rating="1" tabindex="0" role="button" aria-label="Rate Conflict as Good">Trivial or weak tension</td>
                  <td data-category="2" data-rating="2" tabindex="0" role="button" aria-label="Rate Conflict as Great">Predictable obstacle</td>
                  <td data-category="2" data-rating="3" tabindex="0" role="button" aria-label="Rate Conflict as Excellent">Engaging stakes keep interest</td>
                  <td data-category="2" data-rating="4" tabindex="0" role="button" aria-label="Rate Conflict as Outstanding">High-stakes drama hooks viewers</td>
                </tr>
                <tr>
                  <td class="tooltip">🛑 Challenges <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="3"><span class="tooltiptext">Tasks or hurdles to overcome</span></td>
                  <td data-category="3" data-rating="1" tabindex="0" role="button" aria-label="Rate Challenges as Good">Easy or forced hurdles</td>
                  <td data-category="3" data-rating="2" tabindex="0" role="button" aria-label="Rate Challenges as Great">Routine tasks, expected</td>
                  <td data-category="3" data-rating="3" tabindex="0" role="button" aria-label="Rate Challenges as Excellent">Balanced, exciting challenges</td>
                  <td data-category="3" data-rating="4" tabindex="0" role="button" aria-label="Rate Challenges as Outstanding">Dynamic, unique obstacles</td>
                </tr>
                <tr>
                  <td class="tooltip">📈 Retention <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="4"><span class="tooltiptext">Keeping viewers watching</span></td>
                  <td data-category="4" data-rating="1" tabindex="0" role="button" aria-label="Rate Retention as Good">Boring, no engagement</td>
                  <td data-category="4" data-rating="2" tabindex="0" role="button" aria-label="Rate Retention as Great">Some peaks, uneven pacing</td>
                  <td data-category="4" data-rating="3" tabindex="0" role="button" aria-label="Rate Retention as Excellent">Well-paced with hooks</td>
                  <td data-category="4" data-rating="4" tabindex="0" role="button" aria-label="Rate Retention as Outstanding">Suspenseful, constant pull</td>
                </tr>
                <tr>
                  <td class="tooltip">🚀 Originality <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="5"><span class="tooltiptext">Uniqueness of the idea</span></td>
                  <td data-category="5" data-rating="1" tabindex="0" role="button" aria-label="Rate Originality as Good">Cliché or overdone idea</td>
                  <td data-category="5" data-rating="2" tabindex="0" role="button" aria-label="Rate Originality as Great">Familiar with small twist</td>
                  <td data-category="5" data-rating="3" tabindex="0" role="button" aria-label="Rate Originality as Excellent">Distinct, fresh approach</td>
                  <td data-category="5" data-rating="4" tabindex="0" role="button" aria-label="Rate Originality as Outstanding">Innovative, boundary-pushing</td>
                </tr>
                <tr>
                  <td class="tooltip">📖 Story <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="6"><span class="tooltiptext">Narrative and emotional arc</span></td>
                  <td data-category="6" data-rating="1" tabindex="0" role="button" aria-label="Rate Story as Good">Flat, no stakes</td>
                  <td data-category="6" data-rating="2" tabindex="0" role="button" aria-label="Rate Story as Great">Basic arc, predictable</td>
                  <td data-category="6" data-rating="3" tabindex="0" role="button" aria-label="Rate Story as Excellent">Engaging narrative</td>
                  <td data-category="6" data-rating="4" tabindex="0" role="button" aria-label="Rate Story as Outstanding">Emotional, gripping tale</td>
                </tr>
                <tr>
                  <td class="tooltip">🎥 Feasibility <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="7"><span class="tooltiptext">Can you realistically film it?</span></td>
                  <td data-category="7" data-rating="1" tabindex="0" role="button" aria-label="Rate Feasibility as Good">Unrealistic, vague plan</td>
                  <td data-category="7" data-rating="2" tabindex="0" role="button" aria-label="Rate Feasibility as Great">Possible but unclear logistics</td>
                  <td data-category="7" data-rating="3" tabindex="0" role="button" aria-label="Rate Feasibility as Excellent">Planned with resources</td>
                  <td data-category="7" data-rating="4" tabindex="0" role="button" aria-label="Rate Feasibility as Outstanding">Fully ready to execute</td>
                </tr>
                <tr>
                  <td class="tooltip">🎨 Visuals <input type="number" step="0.1" min="0.5" max="2" value="1" class="weight" data-category="8"><span class="tooltiptext">Visual appeal for thumbnails/views</span></td>
                  <td data-category="8" data-rating="1" tabindex="0" role="button" aria-label="Rate Visuals as Good">Dull or uninspired look</td>
                  <td data-category="8" data-rating="2" tabindex="0" role="button" aria-label="Rate Visuals as Great">Average, basic visuals</td>
                  <td data-category="8" data-rating="3" tabindex="0" role="button" aria-label="Rate Visuals as Excellent">Appealing, eye-catching</td>
                  <td data-category="8" data-rating="4" tabindex="0" role="button" aria-label="Rate Visuals as Outstanding">Stunning, click-worthy</td>
                </tr>
              </tbody>
            </table>
          </div>
          <button class="btn" onclick="undo()">Undo</button>
          <button class="btn" onclick="redo()">Redo</button>
          <button class="btn" onclick="showTab('feedback')">Next: Get Feedback</button>
        </section>

        <!-- Feedback -->
        <section id="feedback" class="tab glass-panel">
          <h2>💡 Next Steps</h2>
          <div id="feedbackOutput"></div>
          <textarea id="humanFeedback" class="story-input" placeholder="Weakest part? Best twist? Production concerns?"></textarea>
          <button class="btn" onclick="togglePrompts()">Show Prompts</button>
          <ul id="prompts">
            <li>What’s your retention peak?</li>
            <li>Any plot holes or unclear moments?</li>
            <li>What’s the emotional payoff?</li>
            <li>Any production risks to address?</li>
          </ul>
          <button class="btn" onclick="showTab('plan')">Next: Production Plan</button>
        </section>

        <!-- Production Plan -->
        <section id="plan" class="tab glass-panel">
          <h2>🎬 Production Plan</h2>
          <div id="plannerList"></div>
          <div id="timeline" class="glass-panel">
            <h3>Timeline</h3>
            <div id="timelineBlocks"></div>
            <button class="btn" onclick="addTimelineBlock()">Add Beat</button>
          </div>
          <div id="thumbnail" class="glass-panel">
            <h3>Thumbnail Idea</h3>
            <input type="text" id="thumbnailInput" class="story-input" style="min-height: 50px;" placeholder="e.g., Shocked face with rare pet">
          </div>
          <select id="exportFormat">
            <option value="png">PNG</option>
            <option value="text">Text</option>
          </select>
          <button class="btn" onclick="exportShareCode()">Share Plan</button>
          <button class="btn" onclick="importShareCode()">Import Plan</button>
          <button class="btn" onclick="exportPlan()">Export Everything</button>
          <button class="btn" onclick="submitToShowcase()">Submit to Showcase</button>
          <button class="btn" onclick="resetAll()">Reset All</button>
        </section>
      </main>

      <!-- Footer -->
      <footer>
        <p>Created by loverfellayt - <a href="https://youtube.com/@yourchannel" target="_blank">Subscribe!</a></p>
      </footer>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- JavaScript -->
    <script>
      let scores = {};
      let history = [];
      let historyIndex = -1;

      window.addEventListener('DOMContentLoaded', () => {
        // Load saved state
        const savedScores = JSON.parse(localStorage.getItem('scores') || '{}');
        scores = savedScores;
        Object.entries(scores).forEach(([cat, rating]) => {
          const cell = document.querySelector(`td[data-category="${cat}"][data-rating="${rating}"]`);
          if (cell) cell.classList.add('selected');
        });
        document.getElementById('quickSummary').value = localStorage.getItem('quickSummary') || '';
        document.getElementById('humanFeedback').value = localStorage.getItem('humanFeedback') || '';
        document.getElementById('thumbnailInput').value = localStorage.getItem('thumbnail') || '';
        updateWordCount();
        updateProgress();
        updateTemplateDropdown();

        // Dark mode
        if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.setAttribute('data-theme', 'dark');
          document.getElementById('darkModeToggle').textContent = '☀️';
        }

        // Event Listeners
        document.getElementById('darkModeToggle').addEventListener('click', () => {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          document.documentElement.setAttribute('data-theme', isDark ? '' : 'dark');
          localStorage.setItem('darkMode', !isDark);
          document.getElementById('darkModeToggle').textContent = isDark ? '🌙' : '☀️';
        });

        document.getElementById('examples').addEventListener('change', (e) => {
          if (e.target.value) {
            document.getElementById('quickSummary').value = e.target.value;
            localStorage.setItem('quickSummary', e.target.value);
            updateWordCount();
            autoResize({ target: document.getElementById('quickSummary') });
            saveToHistory();
          }
        });

        document.getElementById('templates').addEventListener('change', (e) => loadTemplate(e.target.value));

        document.getElementById('quickSummary').addEventListener('input', () => {
          localStorage.setItem('quickSummary', document.getElementById('quickSummary').value);
          updateWordCount();
          updateProgress();
          autoResize({ target: document.getElementById('quickSummary') });
          saveToHistory();
        });
        document.getElementById('humanFeedback').addEventListener('input', () => {
          localStorage.setItem('humanFeedback', document.getElementById('humanFeedback').value);
          updateProgress();
          autoResize({ target: document.getElementById('humanFeedback') });
          saveToHistory();
        });
        document.getElementById('thumbnailInput').addEventListener('input', () => {
          localStorage.setItem('thumbnail', document.getElementById('thumbnailInput').value);
          saveToHistory();
        });

        document.querySelectorAll('.modern-table td[data-rating]').forEach(cell => {
          cell.addEventListener('click', () => { selectRating(cell); updateProgress(); });
          cell.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              selectRating(cell);
              updateProgress();
            }
          });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey) {
            switch (e.key) {
              case '1': showTab('concept'); break;
              case '2': showTab('score'); break;
              case '3': showTab('feedback'); break;
              case '4': showTab('plan'); break;
              case 'z': undo(); break;
              case 'y': redo(); break;
            }
          }
        });

        // Show initial tab
        showTab('concept');
      });

      function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
        if (tabId === 'feedback') updateFeedback();
        if (tabId === 'plan') updatePlanner();
        updateProgress();
      }

      function selectRating(cell) {
        const categoryIndex = Number(cell.getAttribute('data-category'));
        const rating = parseInt(cell.getAttribute('data-rating'));
        const row = cell.parentElement;
        row.querySelectorAll('td').forEach(td => {
          if (td !== row.firstElementChild) td.classList.remove('selected');
        });
        cell.classList.add('selected');
        scores[categoryIndex] = rating;
        localStorage.setItem('scores', JSON.stringify(scores));
        saveToHistory();
      }

      function updateWordCount() {
        const text = document.getElementById('quickSummary').value;
        const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
        document.getElementById('wordCount').textContent = wordCount;
      }

      function autoResize(e) {
        const textarea = e.target;
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
      }

      function calculateTotalScore() {
        return Object.entries(scores).reduce((total, [cat, score]) => {
          const weight = parseFloat(document.querySelector(`.weight[data-category="${cat}"]`).value) || 1;
          return total + (score * weight);
        }, 0);
      }

      function updateFeedback() {
        const feedback = [];
        if ((scores[0] || 0) < 3) feedback.push("Hook: Add a surprising stat, question, or action in the first 10 seconds.");
        if ((scores[1] || 0) < 3) feedback.push("Goal: Clarify what you’re aiming for—make it specific and exciting.");
        if ((scores[2] || 0) < 3) feedback.push("Conflict: Raise stakes with a bigger obstacle or time limit.");
        if ((scores[3] || 0) < 3) feedback.push("Challenges: Add unique or unexpected hurdles to overcome.");
        if ((scores[4] || 0) < 3) feedback.push("Retention: Plan peaks every 30 seconds—cuts, reveals, or twists.");
        if ((scores[5] || 0) < 3) feedback.push("Originality: Twist a trend or combine two ideas for a fresh angle.");
        if ((scores[6] || 0) < 3) feedback.push("Story: Deepen emotional stakes—why should viewers care?");
        if ((scores[7] || 0) < 3) feedback.push("Feasibility: List resources needed to make this doable.");
        if ((scores[8] || 0) < 3) feedback.push("Visuals: Add bold colors, effects, or Roblox assets to pop.");
        const keywordSuggestions = getKeywordSuggestions(document.getElementById('quickSummary').value.toLowerCase());
        feedback.push(...keywordSuggestions);
        document.getElementById('feedbackOutput').innerHTML = `<ul>${feedback.map(item => `<li>${item}</li>`).join('') || '<li>Your concept looks solid—ready to plan!</li>'}</ul>`;
      }

      function getKeywordSuggestions(summary) {
        const suggestions = [];
        if (summary.includes('roblox')) suggestions.push("Add a Roblox-specific twist (e.g., rare item reveal).");
        if (summary.includes('challenge')) suggestions.push("Set a clear win/lose condition for the challenge.");
        if (summary.includes('prank')) suggestions.push("Plan a funny reveal moment for maximum laughs.");
        return suggestions;
      }

      function updatePlanner() {
        const summary = document.getElementById('quickSummary').value.toLowerCase();
        const planner = [
          "Script your hook scene (first 10-15 seconds).",
          summary.includes('roblox') ? "Set up Roblox Studio with required assets." : "Gather filming equipment (camera, mic, etc.).",
          (scores[2] || 0) < 3 ? "Plan a key conflict moment (e.g., mid-video escalation)." : "Reinforce your conflict scene with timing.",
          (scores[7] || 0) < 3 ? "List props, locations, or tools needed." : "Confirm all resources are ready (e.g., props, software).",
          "Schedule 2-3 retention peaks (e.g., reveals, cuts, surprises).",
          (scores[8] || 0) < 3 ? "Design a standout visual (e.g., effect, thumbnail idea)." : "Polish your visual hook for impact.",
          "Write a call-to-action for the ending (e.g., like, subscribe)."
        ];
        document.getElementById('plannerList').innerHTML = `<ul>${planner.map(item => `<li>${item}</li>`).join('')}</ul><p>Estimated Length: ${estimateLength()}</p>`;
      }

      function addTimelineBlock() {
        const block = document.createElement('div');
        block.className = 'timeline-block';
        block.innerHTML = '<input type="text" placeholder="e.g., Hook: Pet escapes" style="width: 200px;">';
        document.getElementById('timelineBlocks').appendChild(block);
        saveToHistory();
      }

      function getTimeline() {
        return Array.from(document.querySelectorAll('.timeline-block input')).map(input => input.value).filter(v => v);
      }

      function estimateLength() {
        const timelineBlocks = getTimeline().length;
        const baseTime = timelineBlocks * 60; // 1 minute per block
        const retentionScore = scores[4] || 2; // Default to Great (2)
        const multiplier = retentionScore >= 3 ? 1 : 1.2; // Slower pacing if retention is low
        const estimatedSeconds = Math.round(baseTime * multiplier);
        return `${Math.floor(estimatedSeconds / 60)}:${(estimatedSeconds % 60).toString().padStart(2, '0')}`;
      }

      function getRubricSummary() {
        const categories = ['Hook', 'Goal', 'Conflict', 'Challenges', 'Retention', 'Originality', 'Story', 'Feasibility', 'Visuals'];
        const ratings = [
          ['Slow or unclear start', 'Basic hook, mildly curious', 'Intriguing opener draws interest', 'Unignorable, instant grab'],
          ['Vague or hidden purpose', 'Goal present but unclear', 'Well-defined objective', 'Crystal-clear, high-stakes aim'],
          ['Trivial or weak tension', 'Predictable obstacle', 'Engaging stakes keep interest', 'High-stakes drama hooks viewers'],
          ['Easy or forced hurdles', 'Routine tasks, expected', 'Balanced, exciting challenges', 'Dynamic, unique obstacles'],
          ['Boring, no engagement', 'Some peaks, uneven pacing', 'Well-paced with hooks', 'Suspenseful, constant pull'],
          ['Cliché or overdone idea', 'Familiar with small twist', 'Distinct, fresh approach', 'Innovative, boundary-pushing'],
          ['Flat, no stakes', 'Basic arc, predictable', 'Engaging narrative', 'Emotional, gripping tale'],
          ['Unrealistic, vague plan', 'Possible but unclear logistics', 'Planned with resources', 'Fully ready to execute'],
          ['Dull or uninspired look', 'Average, basic visuals', 'Appealing, eye-catching', 'Stunning, click-worthy']
        ];
        return Object.entries(scores).map(([cat, score]) => {
          const weight = parseFloat(document.querySelector(`.weight[data-category="${cat}"]`).value) || 1;
          return `${categories[cat]}: ${ratings[cat][score - 1]} (Weighted: ${score * weight})`;
        }).join('<br>');
      }

      function saveToHistory() {
        const state = {
          scores: { ...scores },
          quickSummary: document.getElementById('quickSummary').value,
          humanFeedback: document.getElementById('humanFeedback').value,
          thumbnail: document.getElementById('thumbnailInput').value,
          timeline: getTimeline()
        };
        if (historyIndex < history.length - 1) history = history.slice(0, historyIndex + 1);
        history.push(state);
        historyIndex++;
        localStorage.setItem('history', JSON.stringify(history));
      }

      function undo() {
        if (historyIndex > 0) {
          historyIndex--;
          applyHistoryState(history[historyIndex]);
          showToast('Undo complete!');
        }
      }

      function redo() {
        if (historyIndex < history.length - 1) {
          historyIndex++;
          applyHistoryState(history[historyIndex]);
          showToast('Redo complete!');
        }
      }

      function applyHistoryState(state) {
        scores = { ...state.scores };
        document.querySelectorAll('.selected').forEach(cell => cell.classList.remove('selected'));
        Object.entries(scores).forEach(([cat, rating]) => {
          document.querySelector(`td[data-category="${cat}"][data-rating="${rating}"]`)?.classList.add('selected');
        });
        document.getElementById('quickSummary').value = state.quickSummary;
        document.getElementById('humanFeedback').value = state.humanFeedback;
        document.getElementById('thumbnailInput').value = state.thumbnail;
        document.getElementById('timelineBlocks').innerHTML = '';
        state.timeline.forEach(item => {
          addTimelineBlock();
          document.querySelector('#timelineBlocks input:last-child').value = item;
        });
        updateWordCount();
        updateProgress();
        localStorage.setItem('scores', JSON.stringify(scores));
        localStorage.setItem('quickSummary', state.quickSummary);
        localStorage.setItem('humanFeedback', state.humanFeedback);
        localStorage.setItem('thumbnail', state.thumbnail);
      }

      async function exportPlan() {
        const issues = validatePlan();
        if (issues.length) {
          showToast(`Fix these issues:\n${issues.join('\n')}`, 4000);
          return;
        }

        const format = document.getElementById('exportFormat').value;
        const content = `
          StoryCraft Video Plan
          Concept: ${document.getElementById('quickSummary').value || 'No concept entered yet.'}
          Rubric Scores:
          ${getRubricSummary()}
          Total Weighted Score: ${calculateTotalScore()}
          Feedback: ${document.getElementById('feedbackOutput').textContent}
          Production Plan: ${document.getElementById('plannerList').textContent}
          Timeline: ${getTimeline().join(', ') || 'No timeline blocks added.'}
          Thumbnail: ${document.getElementById('thumbnailInput').value || 'No thumbnail idea yet.'}
          Notes: ${document.getElementById('humanFeedback').value || 'No notes added.'}
        `;

        if (format === 'png') {
          showToast('Exporting PNG... Please wait.');
          const tempContainer = document.createElement('div');
          tempContainer.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-light');
          tempContainer.style.padding = '2rem';
          tempContainer.style.fontFamily = 'Poppins, sans-serif';
          tempContainer.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-light');
          tempContainer.innerHTML = `
            <h1 style="text-align: center; color: var(--highlight); font-size: 2rem;">StoryCraft Video Plan</h1>
            <h2 style="color: var(--primary-light);">Concept</h2><p>${document.getElementById('quickSummary').value || 'No concept entered yet.'}</p>
            <h2 style="color: var(--primary-light);">Rubric Scores</h2><p>${getRubricSummary().replace(/<br>/g, '<br>')}</p>
            <h2 style="color: var(--primary-light);">Total Weighted Score</h2><p>${calculateTotalScore()}</p>
            <h2 style="color: var(--primary-light);">Feedback</h2>${document.getElementById('feedbackOutput').innerHTML}
            <h2 style="color: var(--primary-light);">Production Plan</h2>${document.getElementById('plannerList').innerHTML}
            <h2 style="color: var(--primary-light);">Timeline</h2><ul>${getTimeline().map(item => `<li>${item}</li>`).join('') || '<li>No timeline blocks added.</li>'}</ul>
            <h2 style="color: var(--primary-light);">Thumbnail</h2><p>${document.getElementById('thumbnailInput').value || 'No thumbnail idea yet.'}</p>
            <h2 style="color: var(--primary-light);">Notes</h2><p>${document.getElementById('humanFeedback').value || 'No notes added.'}</p>
          `;
          document.body.appendChild(tempContainer);

          try {
            const canvas = await html2canvas(tempContainer, { scale: 2 });
            const dataUrl = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'storycraft-video-plan.png';
            link.href = dataUrl;
            link.click();
            showToast('Plan exported as PNG!');
          } catch (error) {
            console.error('PNG export failed:', error);
            showToast('Export failed! Check console.', 3000);
          } finally {
            document.body.removeChild(tempContainer);
          }
        } else if (format === 'text') {
          navigator.clipboard.writeText(content.trim());
          showToast('Plan copied to clipboard!');
        }
      }

      function resetAll() {
        scores = {};
        history = [];
        historyIndex = -1;
        document.querySelectorAll('.selected').forEach(cell => cell.classList.remove('selected'));
        document.getElementById('quickSummary').value = '';
        document.getElementById('humanFeedback').value = '';
        document.getElementById('thumbnailInput').value = '';
        document.getElementById('timelineBlocks').innerHTML = '';
        localStorage.clear();
        updateWordCount();
        updateProgress();
        showTab('concept');
        showToast('All data reset!');
      }

      function exportShareCode() {
        const data = {
          scores,
          quickSummary: document.getElementById('quickSummary').value,
          humanFeedback: document.getElementById('humanFeedback').value,
          thumbnail: document.getElementById('thumbnailInput').value,
          timeline: getTimeline()
        };
        const code = btoa(JSON.stringify(data));
        prompt('Copy this share code:', code);
        showToast('Share code generated!');
      }

      function importShareCode() {
        const code = prompt('Paste share code:');
        if (code) {
          try {
            const data = JSON.parse(atob(code));
            scores = data.scores;
            Object.entries(scores).forEach(([cat, rating]) => {
              document.querySelector(`td[data-category="${cat}"][data-rating="${rating}"]`)?.classList.add('selected');
            });
            document.getElementById('quickSummary').value = data.quickSummary;
            document.getElementById('humanFeedback').value = data.humanFeedback;
            document.getElementById('thumbnailInput').value = data.thumbnail;
            document.getElementById('timelineBlocks').innerHTML = '';
            data.timeline.forEach(item => {
              addTimelineBlock();
              document.querySelector('#timelineBlocks input:last-child').value = item;
            });
            updateWordCount();
            updateProgress();
            saveToHistory();
            showToast('Plan imported!');
          } catch (e) {
            showToast('Invalid share code!', 3000);
          }
        }
      }

      function saveTemplate() {
        const name = prompt('Name this template:');
        if (name) {
          const template = {
            quickSummary: document.getElementById('quickSummary').value,
            scores,
            humanFeedback: document.getElementById('humanFeedback').value,
            thumbnail: document.getElementById('thumbnailInput').value,
            timeline: getTimeline()
          };
          const templates = JSON.parse(localStorage.getItem('templates') || '{}');
          templates[name] = template;
          localStorage.setItem('templates', JSON.stringify(templates));
          updateTemplateDropdown();
          showToast('Template saved!');
        }
      }

      function loadTemplate(name) {
        const templates = JSON.parse(localStorage.getItem('templates') || '{}');
        const template = templates[name];
        if (template) {
          resetAll();
          scores = template.scores;
          Object.entries(scores).forEach(([cat, rating]) => {
            document.querySelector(`td[data-category="${cat}"][data-rating="${rating}"]`)?.classList.add('selected');
          });
          document.getElementById('quickSummary').value = template.quickSummary;
          document.getElementById('humanFeedback').value = template.humanFeedback;
          document.getElementById('thumbnailInput').value = template.thumbnail;
          template.timeline.forEach(item => {
            addTimelineBlock();
            document.querySelector('#timelineBlocks input:last-child').value = item;
          });
          updateWordCount();
          updateProgress();
          saveToHistory();
          showToast('Template loaded!');
        }
      }

      function updateTemplateDropdown() {
        const templates = JSON.parse(localStorage.getItem('templates') || '{}');
        const dropdown = document.getElementById('templates');
        dropdown.innerHTML = '<option value="">Load a template</option>' + 
          Object.keys(templates).map(name => `<option value="${name}">${name}</option>`).join('');
      }

      function validatePlan() {
        const issues = [];
        if (!document.getElementById('quickSummary').value) issues.push("Concept is empty.");
        if (Object.keys(scores).length < 5) issues.push("Score at least 5 categories.");
        if (!getTimeline().length) issues.push("Add at least one timeline block.");
        return issues;
      }

      function submitToShowcase() {
        const plan = {
          concept: document.getElementById('quickSummary').value,
          scores,
          feedback: document.getElementById('feedbackOutput').textContent,
          plan: document.getElementById('plannerList').textContent
        };
        console.log('Showcase Submission:', plan);
        showToast('Plan submitted to console—future feature!');
      }

      function updateProgress() {
        let completed = 0;
        if (document.getElementById('quickSummary').value) completed++;
        if (Object.keys(scores).length > 4) completed++;
        if (document.getElementById('humanFeedback').value) completed++;
        if (document.getElementById('plan').classList.contains('active')) completed++;
        document.getElementById('progressText').textContent = `${completed}/4`;
        document.getElementById('progressBar').style.width = `${(completed / 4) * 100}%`;
      }

      function togglePrompts() {
        const prompts = document.getElementById('prompts');
        prompts.style.display = prompts.style.display === 'none' ? 'block' : 'none';
      }

      function showToast(message, duration = 2000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', duration);
      }
    </script>
  </body>
</html>
