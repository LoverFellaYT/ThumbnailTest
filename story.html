<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>StoryCraft Analyzer Pro+ Enhanced</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js" defer></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-Fo3rlrZj/k7ujTnH/PRRZ9i6Lkxy/lK+Ad+Qw3PweIIsXgTn5N2sA3ZgP6L6YKn42pPZLNSQNkI3b7HlFj5pAg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Google Font: Roboto -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- CSS Styles -->
    <style>
      :root {
        --primary-light: #4facfe;
        --accent-light: #00f2fe;
        --bg-light: #f9fafb;
        --text-light: #1e293b;
        --panel-light: rgba(255, 255, 255, 0.96);
        --border-light: rgba(255, 255, 255, 0.2);
        --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        --transition: all 0.2s ease;
        --radius: 14px;
        --gradient-light: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-light) 100%);
        --spacing: 1rem;
        --font-base: 'Roboto', sans-serif;
        --table-cell-bg-light: rgba(255, 255, 255, 0.85);
      }
      /* Dark mode variables */
      html[data-theme="dark"] {
        --bg-light: #1f1f1f;
        --text-light: #f3f3f3;
        --panel-light: rgba(18, 18, 18, 0.98);
        --border-light: rgba(255, 255, 255, 0.2);
        --gradient-light: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --table-cell-bg-light: rgba(30, 30, 30, 0.85);
      }
      body {
        margin: 0;
        padding: 0;
        font-family: var(--font-base);
        background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px), var(--bg-light);
        background-size: 30px 30px;
        color: var(--text-light);
        transition: var(--transition);
      }
      .analyzer-container {
        width: 95%;
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 var(--spacing) 2rem;
        text-align: center;
      }

      /* Header / Sticky Banner */
      header.analyzer-header {
        position: sticky;
        top: 0;
        z-index: 1000;
        padding: 1.5rem 2rem;
        margin-bottom: var(--spacing);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--panel-light);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        animation: headerGlow 3s infinite alternate;
      }
      @keyframes headerGlow {
        from { box-shadow: 0 0 10px rgba(255,215,0,0.5); }
        to { box-shadow: 0 0 30px rgba(255,215,0,1); }
      }
      .header-left {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        text-align: center;
      }
      .main-heading {
        font-size: 2rem;
        margin: 0;
        font-weight: bold;
      }
      .total-score {
        font-size: 1.75rem;
        font-weight: 700;
        background: var(--gradient-light);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .progress-bar-container {
        width: 100%;
        height: 10px;
        background: #eee;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: var(--gradient-light);
        transition: width 0.3s ease;
      }
      .status-indicator {
        font-weight: 600;
      }
      .header-right {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }

      /* Buttons */
      button.btn {
        background: var(--gradient-light);
        color: #fff;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px rgba(126, 34, 206, 0.2);
      }
      button.btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(126, 34, 206, 0.4);
      }

      /* Rainbow button (emoji only) */
      button.rainbow-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
      }
      button.rainbow-btn:hover {
        transform: scale(1.2);
      }

      /* Dark Mode Toggle */
      .dark-mode {
        display: inline-flex;
        align-items: center;
        cursor: pointer; /* Ensures it's clickable */
      }
      .toggle-label {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
      }
      .dark-mode-slider {
        position: relative;
        width: 60px;
        height: 30px;
        background-color: #e0e0e0;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 5px;
        transition: background-color 0.3s;
      }
      .dark-mode-slider .mode-label {
        font-size: 16px;
        user-select: none;
      }
      .dark-mode-slider .slider-thumb {
        position: absolute;
        width: 26px;
        height: 26px;
        background: #fff;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }
      input#darkModeToggle {
        display: none;
      }
      input#darkModeToggle:checked + .dark-mode-slider .slider-thumb {
        transform: translateX(30px);
      }
      input#darkModeToggle:checked + .dark-mode-slider {
        background-color: var(--primary-light);
      }

      /* Glass Panels */
      .glass-panel {
        background: var(--panel-light);
        border: 1px solid var(--border-light);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        backdrop-filter: blur(12px);
        padding: 2rem;
        margin: 1rem 0;
        text-align: center;
      }
      .glass-panel h2 {
        margin-top: 0;
      }

      /* Input Areas */
      .input-section {
        margin: 0.5rem 0;
      }
      .story-input {
        width: 100%;
        min-height: 80px;
        padding: 0.5rem;
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
        font-size: 1rem;
        background: var(--bg-light);
        resize: none;
        transition: var(--transition);
        margin-bottom: 0.5rem;
      }
      .story-input:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
      }
      input[type="text"] {
        padding: 0.5rem;
        width: 70%;
        border: 2px solid var(--border-light);
        border-radius: var(--radius);
      }

      /* Similar Videos */
      .similar-videos-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        justify-content: center;
      }
      .video-thumbnail {
        width: 200px;
        overflow: hidden;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        transition: var(--transition);
        position: relative;
      }
      .video-thumbnail img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
      }
      .video-title {
        padding: 0.5rem;
        font-size: 0.9rem;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0 4px;
        line-height: 1;
      }
      .video-thumbnail:hover {
        transform: scale(1.02);
      }

      /* Rubric Table */
      .rubric-table {
        overflow-x: auto;
        margin: 1rem 0;
      }
      .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 800px;
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: var(--transition);
      }
      .modern-table th,
      .modern-table td {
        padding: 0.5rem 1rem;
        text-align: center;
      }
      .modern-table th {
        font-weight: 500;
        position: sticky;
        top: 0;
        backdrop-filter: blur(10px);
        z-index: 10;
        background: var(--gradient-light);
        color: #fff;
      }
      .modern-table th:nth-child(2) { background: #f87171; color: #fff; }
      .modern-table th:nth-child(3) { background: #fb923c; color: #fff; }
      .modern-table th:nth-child(4) { background: #facc15; color: #000; }
      .modern-table th:nth-child(5) { background: #4ade80; color: #fff; }
      .modern-table td {
        background: var(--table-cell-bg-light);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        vertical-align: middle;
      }
      .modern-table td[data-rating]:hover:not(.selected) {
        background: rgba(224, 231, 255, 0.4);
        transform: scale(1.05);
      }
      .modern-table td.selected {
        background: rgba(224, 231, 255, 0.5) !important;
        border-left: 4px solid var(--primary-light);
      }
      .category-header {
        font-weight: 600;
        background: rgba(79, 172, 254, 0.03);
        position: sticky;
        left: 0;
        min-width: 180px;
      }

      /* Self-Assessment Checklist */
      #selfAssessmentSection ul {
        list-style-type: none;
        padding: 0;
        margin: 0 auto;
        max-width: 600px;
        text-align: left;
      }
      #selfAssessmentSection li {
        margin-bottom: 0.5rem;
      }
      #selfAssessmentSection li label {
        cursor: pointer;
      }

      @media (max-width: 768px) {
        header.analyzer-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .header-right {
          margin-top: 1rem;
          width: 100%;
          justify-content: space-around;
        }
      }
    </style>
  </head>
  <body>
    <!-- HEADER / Sticky Banner -->
    <header class="analyzer-header">
      <div class="header-left">
        <h1 class="main-heading">StoryCraft Analyzer</h1>
        <div class="total-score">
          Score: <span id="total">0</span>/40 <span id="scoreLabel">Incomplete</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="status-indicator" id="ranking">Incomplete</div>
      </div>
      <div class="header-right" style="pointer-events: auto;">
        <button class="btn" id="resetBtn">🔄 Reset</button>
        <button class="btn" id="exportBtn">🖼️ Export PNG</button>
        <!-- Rainbow Button: Displays only a rainbow emoji -->
        <button class="rainbow-btn" id="rainbowBtn">🌈</button>

        <!-- Dark mode toggle container (ensure it's clickable) -->
        <div class="dark-mode" style="pointer-events: auto;">
          <label class="toggle-label" for="darkModeToggle">
            <input type="checkbox" id="darkModeToggle" aria-label="Toggle Dark Mode"/>
            <div class="dark-mode-slider">
              <span class="mode-label">☀️</span>
              <span class="mode-label">🌙</span>
              <div class="slider-thumb"></div>
            </div>
          </label>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main>
      <div class="analyzer-container">
        <!-- Quick Summary Section -->
        <div class="glass-panel input-section" id="quickSummarySection">
          <h2>📝 Quick Summary</h2>
          <textarea id="quickSummary" class="story-input" placeholder="Summarize the story or video in a few lines..."></textarea>
        </div>
        <!-- Similar Videos Section -->
        <div class="glass-panel input-section" id="similarVideosSection">
          <h2>📺 Similar Videos</h2>
          <input type="text" id="youtubeLinkInput" placeholder="Enter YouTube video URL..."/>
          <button class="btn" id="addVideoBtn">Add Video</button>
          <div id="similarVideosList" class="similar-videos-list"></div>
        </div>
        <!-- Rubric Table Section -->
        <div class="glass-panel rubric-table" id="rubricSection">
          <h2>📊 Rubric Table</h2>
          <table class="modern-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Good (1)</th>
                <th>Great (2)</th>
                <th>Excellent (3)</th>
                <th>Outstanding (4)</th>
              </tr>
            </thead>
            <tbody>
              <!-- Example Row: Hook & Opening -->
              <tr>
                <td class="category-header" data-category="0">🎣 Hook &amp; Opening</td>
                <td data-category="0" data-rating="1">Slow start or unclear hook; doesn’t entice immediate engagement.</td>
                <td data-category="0" data-rating="2">Basic but functional hook; viewers might stay out of mild curiosity.</td>
                <td data-category="0" data-rating="3">Clear, intriguing opening that sparks immediate interest.</td>
                <td data-category="0" data-rating="4">Unignorable opener; compels viewers to keep watching almost instantly.</td>
              </tr>
              <!-- 2. Clarity of Goal -->
              <tr>
                <td class="category-header" data-category="1">🎯 Clarity of Goal</td>
                <td data-category="1" data-rating="1">Goal is vague, hidden, or tacked on.</td>
                <td data-category="1" data-rating="2">Stated goal exists but muddled mid‑video.</td>
                <td data-category="1" data-rating="3">Well‑defined goal, each segment ties back.</td>
                <td data-category="1" data-rating="4">Crystal‑clear premise; high stakes central goal.</td>
              </tr>
              <!-- 3. Audience Retention -->
              <tr>
                <td class="category-header" data-category="2">👀 Audience Retention</td>
                <td data-category="2" data-rating="1">Loses interest quickly; minimal hooks.</td>
                <td data-category="2" data-rating="2">Some engaging points but inconsistent pacing.</td>
                <td data-category="2" data-rating="3">Timely reveals, mini‑cliffhangers, strong pacing.</td>
                <td data-category="2" data-rating="4">No dead spots; consistent reasons to stay.</td>
              </tr>
              <!-- ...Add your other rubric rows below -->
            </tbody>
          </table>
        </div>
        <!-- Self-Assessment Checklist Section -->
        <div class="glass-panel input-section" id="selfAssessmentSection">
          <h2>✅ Self-Assessment Checklist</h2>
          <ul>
            <li>
              <input type="checkbox" id="check1"/>
              <label for="check1"><strong>Hook:</strong> Does the opening grab attention in the first few seconds?</label>
            </li>
            <li>
              <input type="checkbox" id="check2"/>
              <label for="check2"><strong>Goal:</strong> Is the main objective/challenge clearly defined?</label>
            </li>
            <!-- Add more checklist items as needed -->
          </ul>
        </div>
      </div>
    </main>

    <script>
      // For the 10-item rubric, maximum total = 40
      let scores = {};

      // Setup after DOM content is fully loaded
      window.addEventListener('DOMContentLoaded', () => {
        // Rainbow Quote array
        const storyQuotes = [
          "The test of good writing and good story is: does it not only reward the first viewing, but also the second viewing?",
          "Movies are all about the last ten minutes\nTools, not rules",
          "Research wins the war on cliche",
          "If the story you're telling is the story you're telling, you're in deep shit. (soooo good)",
          "You can do whatever you want in your movie, as long as you make sure it works and you know why you’re doing it.",
          "Master your craft. Don't just take your talent for a walk."
          // Add more quotes or reuse from your array as needed
        ];

        // Grab references
        const rainbowBtn = document.getElementById('rainbowBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resetBtn = document.getElementById('resetBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const addVideoBtn = document.getElementById('addVideoBtn');

        // Attach events
        rainbowBtn.addEventListener('click', () => {
          // Show random quote
          const randomIndex = Math.floor(Math.random() * storyQuotes.length);
          alert(storyQuotes[randomIndex]);
        });

        exportBtn.addEventListener('click', exportPNG);
        resetBtn.addEventListener('click', resetScores);
        darkModeToggle.addEventListener('change', toggleTheme);
        addVideoBtn.addEventListener('click', addYouTubeVideo);

        // For Rubric cell clicks
        document.querySelectorAll('.modern-table td[data-rating]').forEach(cell => {
          cell.addEventListener('click', () => selectRating(cell));
        });
        // Auto-resize textareas
        document.querySelectorAll('.story-input').forEach(textarea => {
          textarea.addEventListener('input', autoResize);
        });
      });

      function selectRating(cell) {
        const categoryIndex = Number(cell.getAttribute('data-category'));
        const rating = parseInt(cell.getAttribute('data-rating'));
        const row = cell.parentElement;
        row.querySelectorAll('td').forEach(td => {
          if (td !== row.firstElementChild) td.classList.remove('selected');
        });
        cell.classList.add('selected');
        scores[categoryIndex] = rating;
        updateTotal();
      }

      function updateTotal() {
        const total = Object.values(scores).reduce((a, b) => a + b, 0);
        document.getElementById('total').textContent = total;
        const ranking = document.getElementById('ranking');
        // Only update if all categories are rated (example: 10 categories => check)
        if (Object.keys(scores).length < 10) {
          ranking.textContent = 'Incomplete';
          ranking.style.color = '#64748b';
          updateProgressBar(total);
          return;
        }
        if (total < 21) {
          ranking.textContent = 'Needs Work 🔴';
          ranking.style.color = 'red';
        } else if (total < 30) {
          ranking.textContent = 'Good Start 🟡';
          ranking.style.color = 'orange';
        } else if (total < 40) {
          ranking.textContent = 'Great! 🟢';
          ranking.style.color = 'green';
        } else {
          ranking.textContent = 'Perfect! 🔵';
          ranking.style.color = 'blue';
          if (typeof confetti === 'function') {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
          }
        }
        updateProgressBar(total);
      }

      function updateProgressBar(total) {
        const progressBar = document.getElementById('progressBar');
        const percentage = (total / 40) * 100;
        progressBar.style.width = percentage + "%";
      }

      function autoResize(e) {
        const textarea = e.target;
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }

      async function exportPNG() {
        // Clone the header + main container into a temp container
        const tempContainer = document.createElement('div');
        tempContainer.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bg-light');
        tempContainer.style.padding = "1rem";

        const headerClone = document.querySelector('header.analyzer-header').cloneNode(true);
        const mainClone = document.querySelector('.analyzer-container').cloneNode(true);

        // Append clones
        tempContainer.appendChild(headerClone);
        tempContainer.appendChild(mainClone);
        document.body.appendChild(tempContainer);

        try {
          const canvas = await html2canvas(tempContainer, { scale: 2, useCORS: true });
          const dataUrl = canvas.toDataURL('image/png');
          const link = document.createElement('a');
          link.download = 'storycraft-analysis.png';
          link.href = dataUrl;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (error) {
          console.error('PNG export failed:', error);
          alert('Error exporting PNG. Please try again.');
        }
        document.body.removeChild(tempContainer);
      }

      function resetScores() {
        scores = {};
        document.querySelectorAll('.selected').forEach(cell => cell.classList.remove('selected'));
        // Clear certain textareas if needed
        const summary = document.getElementById('quickSummary');
        if (summary) summary.value = '';
        const ranking = document.getElementById('ranking');
        if (ranking) {
          ranking.textContent = 'Incomplete';
          ranking.style.color = '#64748b';
        }
        // Clear the Similar Videos
        const videoList = document.getElementById('similarVideosList');
        if (videoList) videoList.innerHTML = '';
        // Update the total
        document.getElementById('total').textContent = 0;
        document.getElementById('progressBar').style.width = '0%';
      }

      function toggleTheme(e) {
        if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
        }
      }

      function addYouTubeVideo() {
        const urlInput = document.getElementById('youtubeLinkInput');
        const videoList = document.getElementById('similarVideosList');
        const url = urlInput.value.trim();
        if (!url) return;

        // Simple parse for YouTube ID (basic)
        const vidTitle = prompt("Enter a short video title or label:");
        const thumbDiv = document.createElement('div');
        thumbDiv.classList.add('video-thumbnail');

        // Example approach: just place text. (Add your real parse if needed)
        const label = document.createElement('div');
        label.classList.add('video-title');
        label.textContent = vidTitle || 'Untitled Video';

        // Thumbnail or fallback
        const img = document.createElement('img');
        img.src = 'https://via.placeholder.com/200x150?text=Thumbnail';
        thumbDiv.appendChild(img);
        thumbDiv.appendChild(label);

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-btn');
        removeBtn.innerHTML = '&times;';
        removeBtn.title = 'Remove this video';
        removeBtn.addEventListener('click', () => thumbDiv.remove());
        thumbDiv.appendChild(removeBtn);

        videoList.appendChild(thumbDiv);
        urlInput.value = '';
      }
    </script>
  </body>
</html>
