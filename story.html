<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StoryCraft Analyzer Pro+</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    /* 
      --------------------------------------------------------------
      Custom Properties & Theme 
      --------------------------------------------------------------
    */
    :root {
      --primary: #6366f1;
      --secondary: #4f46e5;
      --accent: #10b981;
      --background: #f8fafc;
      --surface: #ffffff;
      --text: #1e293b;
      --muted: #64748b;

      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      --shadow: 0 8px 32px rgba(31, 38, 135, 0.05);
      --radius: 16px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* 
      --------------------------------------------------------------
      Base Styling
      --------------------------------------------------------------
    */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
      background: var(--background);
      color: var(--text);
      line-height: 1.5;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    button {
      cursor: pointer;
    }

    /*
      --------------------------------------------------------------
      Header & Score Display 
      --------------------------------------------------------------
    */
    .analyzer-header {
      background: var(--surface);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
      border: 1px solid rgba(99, 102, 241, 0.1);
    }
    .score-display {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .total-score {
      font-size: 1.75rem;
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .status-indicator {
      font-weight: 600;
      font-size: 1rem;
      color: var(--muted);
    }
    .controls {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    button {
      background: var(--gradient);
      color: white;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: 10px;
      font-weight: 500;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: var(--shadow);
    }
    button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    /*
      --------------------------------------------------------------
      Input Sections 
      --------------------------------------------------------------
    */
    .input-section {
      background: var(--surface);
      padding: 2rem;
      border-radius: var(--radius);
      margin: 2rem 0;
      box-shadow: var(--shadow);
      border: 1px solid rgba(99, 102, 241, 0.1);
    }
    .input-section h2 {
      margin-bottom: 1.25rem;
      font-size: 1.25rem;
      color: var(--primary);
    }
    .story-input {
      width: 100%;
      min-height: 120px;
      max-height: 600px; /* Just a max to prevent infinite stretching if user pastes a huge text */
      padding: 1rem;
      border: 2px solid rgba(99, 102, 241, 0.1);
      border-radius: 10px;
      font-size: 1rem;
      background: var(--background);
      resize: none; /* We'll auto-resize via JS */
      transition: var(--transition);
      margin-bottom: 0.5rem;
    }
    .story-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    .word-count {
      color: var(--muted);
      font-size: 0.875rem;
      text-align: right;
      margin-top: -0.5rem;
    }

    /*
      --------------------------------------------------------------
      Table & Rubric 
      --------------------------------------------------------------
    */
    .rubric-table {
      background: var(--surface);
      border-radius: var(--radius);
      margin: 2rem 0;
      box-shadow: var(--shadow);
      overflow-x: auto;
      border: 1px solid rgba(99, 102, 241, 0.1);
    }
    .modern-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    .modern-table th {
      background: var(--primary);
      color: white;
      padding: 1rem;
      font-weight: 500;
      text-align: left;
      position: sticky;
      top: 0;
    }
    .modern-table td {
      padding: 1rem;
      background: var(--surface);
      border-bottom: 1px solid rgba(99, 102, 241, 0.05);
      transition: var(--transition);
      vertical-align: top;
    }
    .category-header {
      font-weight: 600;
      background: rgba(99, 102, 241, 0.03);
      position: sticky;
      left: 0;
      min-width: 180px;
    }
    .modern-table tr:hover td:not(.category-header) {
      background: rgba(99, 102, 241, 0.03);
    }
    .selected {
      background: rgba(99, 102, 241, 0.08) !important;
      border-left: 4px solid var(--primary);
    }

    /*
      --------------------------------------------------------------
      Feedback Panel 
      --------------------------------------------------------------
    */
    .feedback-panel {
      background: var(--surface);
      padding: 2rem;
      border-radius: var(--radius);
      margin: 2rem 0;
      box-shadow: var(--shadow);
      border: 1px solid rgba(99, 102, 241, 0.1);
    }
    .feedback-panel h2 {
      font-size: 1.25rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }
    .ai-suggestions {
      background: rgba(16, 185, 129, 0.03);
      padding: 1.5rem;
      border-radius: 10px;
      margin-top: 1.5rem;
      border: 1px solid rgba(16, 185, 129, 0.1);
    }

    /*
      --------------------------------------------------------------
      Responsive 
      --------------------------------------------------------------
    */
    @media (max-width: 768px) {
      body {
        padding: 0 1rem;
      }
      .analyzer-header {
        padding: 1.5rem;
      }
      .controls {
        gap: 0.75rem;
      }
      button {
        width: 100%;
        justify-content: center;
      }
      .input-section {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>

  <div class="analyzer-header">
    <div class="score-display">
      <div class="total-score">Score: <span id="total">0</span>/40</div>
      <div class="status-indicator" id="ranking">Incomplete</div>
    </div>
    <div class="controls">
      <button onclick="resetScores()">üîÑ Reset</button>
      <button onclick="exportPDF()">üì• Export PDF</button>
      <button onclick="getAISuggestions()">ü§ñ AI Insights</button>
    </div>
  </div>

  <!-- Optional quick summary field for story reviews -->
  <div class="input-section">
    <h2>Quick Summary</h2>
    <textarea 
      id="quickSummary" 
      class="story-input" 
      placeholder="Summarize the story or video in a few lines (e.g., main plot points, key message)...">
    </textarea>
  </div>

  <div class="input-section">
    <h2>Your Story</h2>
    <textarea 
      id="storyInput" 
      class="story-input" 
      placeholder="Start typing or paste your story here...">
    </textarea>
    <div class="word-count" id="wordCount">0 words</div>
  </div>

  <div class="input-section">
    <h2>Human Feedback</h2>
    <textarea 
      id="humanFeedback" 
      class="story-input" 
      placeholder="Add your own notes and feedback here..."
      style="min-height: 100px;">
    </textarea>
  </div>

  <div class="input-section">
    <h2>AI Suggestions</h2>
    <textarea 
      id="aiFeedback" 
      class="story-input" 
      placeholder="Paste AI-generated feedback here..."
      style="min-height: 100px;">
    </textarea>
  </div>

  <div class="rubric-table">
    <table class="modern-table">
      <thead>
        <tr>
          <th>Category</th>
          <th>Good (1)</th>
          <th>Great (2)</th>
          <th>Excellent (3)</th>
          <th>Outstanding (4)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="category-header">Hook & Opening</td>
          <td data-category="0" data-rating="1">Slow start; no hook</td>
          <td data-category="0" data-rating="2">Basic hook</td>
          <td data-category="0" data-rating="3">Intriguing hook</td>
          <td data-category="0" data-rating="4">Unignorable opener</td>
        </tr>
        <tr>
          <td class="category-header">Clarity of Goal</td>
          <td data-category="1" data-rating="1">No clear purpose</td>
          <td data-category="1" data-rating="2">Goal exists but gets lost</td>
          <td data-category="1" data-rating="3">Clear goal w/ minor tangents</td>
          <td data-category="1" data-rating="4">Crystal-clear premise</td>
        </tr>
        <tr>
          <td class="category-header">Audience Retention</td>
          <td data-category="2" data-rating="1">Drags/loses viewers quickly</td>
          <td data-category="2" data-rating="2">A few engaging moments</td>
          <td data-category="2" data-rating="3">Strong pacing & reveals</td>
          <td data-category="2" data-rating="4">Masterful tension arcs</td>
        </tr>
        <tr>
          <td class="category-header">Authenticity & Relatability</td>
          <td data-category="3" data-rating="1">Feels forced; no connection</td>
          <td data-category="3" data-rating="2">Some genuine moments</td>
          <td data-category="3" data-rating="3">Relatable & sincere</td>
          <td data-category="3" data-rating="4">Deeply authentic</td>
        </tr>
        <tr>
          <td class="category-header">Emotional Arc & Payoff</td>
          <td data-category="4" data-rating="1">Flat; no highs/lows</td>
          <td data-category="4" data-rating="2">Moments of excitement</td>
          <td data-category="4" data-rating="3">Clear emotional journey</td>
          <td data-category="4" data-rating="4">Masterful peaks/valleys</td>
        </tr>
        <tr>
          <td class="category-header">Conflict & Stakes</td>
          <td data-category="5" data-rating="1">Low urgency</td>
          <td data-category="5" data-rating="2">Basic stakes</td>
          <td data-category="5" data-rating="3">High stakes/punishments</td>
          <td data-category="5" data-rating="4">Unavoidable drama</td>
        </tr>
        <tr>
          <td class="category-header">CTA & Audience Interaction</td>
          <td data-category="6" data-rating="1">No or weak CTA</td>
          <td data-category="6" data-rating="2">Generic "like/subscribe"</td>
          <td data-category="6" data-rating="3">Clear creative CTA</td>
          <td data-category="6" data-rating="4">Actionable & emotional CTA</td>
        </tr>
        <tr>
          <td class="category-header">Originality & Trend-Jacking</td>
          <td data-category="7" data-rating="1">Clich√© concept</td>
          <td data-category="7" data-rating="2">Minor twist on trends</td>
          <td data-category="7" data-rating="3">Fresh angle</td>
          <td data-category="7" data-rating="4">Boundary-pushing</td>
        </tr>
        <tr>
          <td class="category-header">Replayability & Shareability</td>
          <td data-category="8" data-rating="1">Forgettable</td>
          <td data-category="8" data-rating="2">Some memeable moments</td>
          <td data-category="8" data-rating="3">Highly shareable</td>
          <td data-category="8" data-rating="4">Clip-worthy highlights</td>
        </tr>
        <tr>
          <td class="category-header">Branding Consistency</td>
          <td data-category="9" data-rating="1">No branding</td>
          <td data-category="9" data-rating="2">Basic branding</td>
          <td data-category="9" data-rating="3">Consistent style</td>
          <td data-category="9" data-rating="4">Iconic brand identity</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="feedback-panel" id="feedback">
    <h2>Improvement Recommendations</h2>
    <div id="specificFeedback" style="margin-top: 1rem;"></div>
    <div class="ai-suggestions" id="aiSuggestions" style="margin-top: 1rem;"></div>
  </div>

  <script>
    /*
      --------------------------------------------------------------
      Improvement Tips for Each Category/Rating
      --------------------------------------------------------------
    */
    const improvementTips = {
      0: {
        1: "Open with a strong statement or immediate action scene.",
        2: "Hook is decent, but try adding an element of mystery/surprise.",
        3: "Strong opener‚Äîamp it up with quick visuals or an attention-grabbing fact.",
        4: "Outstanding! Keep layering tension in the first seconds."
      },
      1: {
        1: "Establish or restate a clear goal earlier.",
        2: "Tie main points back to the goal more frequently.",
        3: "Goal is clear, just ensure no segment drifts off-topic.",
        4: "Perfect clarity‚Äîeverything ties neatly to the objective!"
      },
      2: {
        1: "Edit out slower sections or unnecessary filler.",
        2: "Insert mini-challenges or interactions to maintain pacing.",
        3: "Use chapter-like segments to sustain engagement.",
        4: "Nailed it! Tension arcs & reveals keep viewers hooked."
      },
      3: {
        1: "Bring more natural personality or honest reactions.",
        2: "Show behind-the-scenes or personal anecdotes.",
        3: "Great authenticity‚Äîkeep sharing relatable moments.",
        4: "Flawlessly real. Audience feels like they're with you."
      },
      4: {
        1: "Build stronger emotional beats or turning points.",
        2: "Add a resolution or reflection at the end.",
        3: "Solid emotional arc‚Äîconsider a final 'lesson learned.'",
        4: "Masterpiece arcs: every high/low carefully orchestrated."
      },
      5: {
        1: "Increase tension or introduce a meaningful challenge.",
        2: "Add time constraints or higher penalties for failing.",
        3: "Audience must sense real consequences‚Äîgood job!",
        4: "Peak drama‚Äîfantastic payoff for each conflict."
      },
      6: {
        1: "Try a direct CTA: ask a question or request input.",
        2: "Link the CTA to the story content or theme.",
        3: "Creative CTA that fosters real interaction‚Äîexcellent.",
        4: "Truly compelling CTA that resonates on emotional level."
      },
      7: {
        1: "Combine niche trends with personal flair.",
        2: "Experiment with new angles or fresh crossovers.",
        3: "Your originality stands out‚Äîkeep brainstorming unique ideas.",
        4: "Innovative & bold‚Äîyou're setting trends, not just following!"
      },
      8: {
        1: "Add distinctive moments or comedic bits for replay/share.",
        2: "Sprinkle in surprising or jaw-dropping scenes.",
        3: "People will want to share this‚Äîgood job!",
        4: "Highly viral potential. Perfectly timed shareable peaks."
      },
      9: {
        1: "Use consistent on-screen elements & styling.",
        2: "Try a short brand intro or recurring motif.",
        3: "Brand theme is recognizable‚Äîwell done!",
        4: "Iconic brand identity‚Äîinstantly recognizable!"
      }
    };

    /*
      --------------------------------------------------------------
      Score Tracking & Interaction 
      --------------------------------------------------------------
    */
    let scores = {};

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.modern-table td[data-rating]').forEach(cell => {
        cell.addEventListener('click', () => selectRating(cell));
      });

      // Add auto-resize functionality to textareas
      const autoResizeTextareas = document.querySelectorAll('.story-input');
      autoResizeTextareas.forEach(textarea => {
        textarea.addEventListener('input', autoResize);
        // Trigger initial resize if there's existing text
        autoResize({ target: textarea });
      });
    });

    function selectRating(cell) {
      const categoryIndex = Number(cell.getAttribute('data-category'));
      const rating = parseInt(cell.getAttribute('data-rating'));

      const row = cell.parentElement;
      row.querySelectorAll('td').forEach(td => {
        if(td !== row.firstElementChild) td.classList.remove('selected');
      });

      cell.classList.add('selected');
      scores[categoryIndex] = rating;
      updateTotal();
      showFeedback();
    }

    function updateTotal() {
      const total = Object.values(scores).reduce((a, b) => a + b, 0);
      document.getElementById('total').textContent = total;
      const ranking = document.getElementById('ranking');

      if (Object.keys(scores).length < 10) {
        ranking.textContent = 'Incomplete';
        ranking.style.color = '#64748b';
        return;
      }
      // Adjust the thresholds as needed
      if (total <= 24) {
        ranking.textContent = 'Needs Work üî¥';
        ranking.style.color = '#ef4444';
      } else if (total <= 32) {
        ranking.textContent = 'Good Start üü°';
        ranking.style.color = '#eab308';
      } else if (total <= 38) {
        ranking.textContent = 'Great! üü¢';
        ranking.style.color = '#22c55e';
      } else {
        ranking.textContent = 'Perfect! üîµ';
        ranking.style.color = '#3b82f6';
      }
    }

    function showFeedback() {
      const feedbackDiv = document.getElementById('specificFeedback');
      feedbackDiv.innerHTML = Object.keys(scores).map(cat => {
        const rating = scores[cat];
        return `
          <div class="feedback-item" 
               style="margin: 0.5rem 0; padding: 1rem; background: rgba(99, 102, 241, 0.05); border-radius: 8px;">
            <strong style="color: ${getCategoryColor(cat)}">
              ${document.querySelectorAll('.category-header')[cat].textContent}:
            </strong>
            <span style="color: #475569;">
              ${improvementTips[cat][rating]}
            </span>
          </div>`;
      }).join('');
    }

    function getCategoryColor(cat) {
      const colors = [
        '#6366f1', '#ec4899', '#eab308', '#10b981',
        '#3b82f6', '#8b5cf6', '#ef4444', '#f97316',
        '#14b8a6', '#64748b'
      ];
      return colors[Number(cat)];
    }

    function resetScores() {
      scores = {};
      document.querySelectorAll('.selected').forEach(cell => cell.classList.remove('selected'));
      document.getElementById('specificFeedback').innerHTML = '';

      // Clear all text inputs
      ['storyInput','humanFeedback','aiFeedback','quickSummary'].forEach(id => {
        document.getElementById(id).value = '';
      });
      document.getElementById('aiSuggestions').innerHTML = '';

      // Reset word count
      document.getElementById('wordCount').textContent = '0 words';
      updateTotal();
      document.getElementById('ranking').textContent = 'Incomplete';
      document.getElementById('ranking').style.color = '#64748b';

      // Auto-resize textareas after resetting
      const autoResizeTextareas = document.querySelectorAll('.story-input');
      autoResizeTextareas.forEach(textarea => {
        autoResize({ target: textarea });
      });
    }

    /*
      --------------------------------------------------------------
      Auto-Resize Textareas so all content is visible 
      (Important for html2canvas to capture entire text)
      --------------------------------------------------------------
    */
    function autoResize(e) {
      const textarea = e.target;
      // Reset the height so scrollHeight will be calculated accurately
      textarea.style.height = 'auto';
      // Set to scrollHeight plus a little padding
      textarea.style.height = textarea.scrollHeight + 'px';
    }

    /*
      --------------------------------------------------------------
      Word Count for the main story input
      --------------------------------------------------------------
    */
    document.getElementById('storyInput').addEventListener('input', function(e) {
      const text = e.target.value;
      let wordCount = 0;
      const trimmed = text.trim();
      if (trimmed) {
        wordCount = trimmed.split(/\s+/).length;
      }
      document.getElementById('wordCount').textContent = `${wordCount} words`;
    });

    /*
      --------------------------------------------------------------
      AI Suggestions Simulation 
      --------------------------------------------------------------
    */
    async function getAISuggestions() {
      const aiDiv = document.getElementById('aiSuggestions');
      aiDiv.innerHTML = '<div class="loading-spinner">‚è≥</div> Analyzing story structure...';

      setTimeout(() => {
        const suggestions = [
          "Consider adding a dramatic turning point around the midpoint.",
          "Reveal deeper motivations for your main character.",
          "Add more sensory details to immerse the reader.",
          "Emphasize a strong conclusion to leave a lasting impact."
        ];
        aiDiv.innerHTML = '<strong>Narrative Insights:</strong><br>' + 
          suggestions.map(s => `‚Ä¢ ${s}`).join('<br>');
      }, 1500);
    }

    /*
      --------------------------------------------------------------
      PDF Export 
      --------------------------------------------------------------
    */
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      // Identify the sections we want to capture
      const elements = [
        document.querySelector('.analyzer-header'),
        document.querySelector('#quickSummary').parentElement,
        document.querySelector('#storyInput').parentElement,
        document.querySelector('#humanFeedback').parentElement,
        document.querySelector('#aiFeedback').parentElement,
        document.querySelector('.rubric-table'),
        document.querySelector('.feedback-panel')
      ];

      let yPos = 10;
      try {
        for (const element of elements) {
          // Expand the element fully so textareas show all content
          const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            windowHeight: element.scrollHeight,
            scrollY: -window.scrollY
          });

          const imgData = canvas.toDataURL('image/png');
          const imgProps = doc.getImageProperties(imgData);
          const pdfWidth = doc.internal.pageSize.getWidth() - 20; 
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

          // If the next element won't fit on this page, add a new page
          if (yPos + pdfHeight > doc.internal.pageSize.getHeight()) {
            doc.addPage();
            yPos = 10;
          }

          doc.addImage(imgData, 'PNG', 10, yPos, pdfWidth, pdfHeight);
          yPos += pdfHeight + 10;
        }
        doc.save('storycraft-analysis-report.pdf');
      } catch (error) {
        console.error('PDF generation failed:', error);
        alert('Error generating PDF. Please try again.');
      }
    }
  </script>
</body>
</html>
